<img src="./2kpzjmhw.png"
style="width:1.76333in;height:0.47167in" /><img src="./dkxiuri1.png" style="width:2.975in;height:2.755in" />

> **F900** **人脸识别模块**
>
> **用户手册**
>
> 杭州城章科技有限公司 2023年 3 月 Ver 1.0
>
> <img src="./hnnf3ulp.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> 版本修订

||
||
||
||
||

www.hzgrow.com

> <img src="./uut2rfbu.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> 目录
>
> 1
> 概述..........................................................................................................................................1
>
> 2
> 产品介绍..................................................................................................................................2
>
> 2.1
> 产品规格........................................................................................................................2
>
> 2、
> 工作条件..............................................................................................................................
> 3
>
> 2.2
> 模组框图........................................................................................................................4
>
> 2.3
> 模组正反面示意图.........................................................................................................4
>
> 2.4
> 产品组成........................................................................................................................4
>
> 2.5
> 模组管脚定义................................................................................................................
> 5
>
> 2.5.1
> 通讯接口.............................................................................................................5
>
> 2.5.2
> 管脚布局图..........................................................................................................5
>
> 2.5.3
> 模组管脚定义......................................................................................................5
>
> 2.6
> 模组结构图....................................................................................................................6
>
> 2.6.1
> 双目摄像头板和核心计算板................................................................................6
>
> 3
> 功能描述..................................................................................................................................7
>
> 3.1
> 工作模式........................................................................................................................7
>
> 3.2
> 电源设计........................................................................................................................7
>
> ⑴
> 引脚介绍..............................................................................................................7
>
> ⑵
> 减少电压跌落.......................................................................................................7
>
> 3.3
> 开关机...........................................................................................................................
> 8
>
> ⑴
> 开机.....................................................................................................................
> 8
>
> ⑵
> 关机.....................................................................................................................
> 8
>
> 4
> 安装..........................................................................................................................................9
>
> ⑴
> 丝印与油墨设计：..............................................................................................9
>
> ⑵
> 模组镜头安装角度：............................................................................................9
>
> 5
> 注意事项................................................................................................................................10
>
> 6
> 通讯接口................................................................................................................................
> 11
>
> 7
> 指令格式详解.........................................................................................................................11
>
> 7.1
> 指令基本格式...............................................................................................................11
>
> 8
> 通信消息详解.........................................................................................................................12
>
> 8.1
> 通信消息类型..............................................................................................................12
>
> 9
> 指令详解................................................................................................................................14
>
> 9.1
> 消息接收指令(H→M)..................................................................................................
> 14

www.hzgrow.com

> <img src="./zalrgpy1.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> 9.2
> 消息发送指令(M→H)..................................................................................................
> 18
>
> 9.2.1 REPLY
> 消息的发送...........................................................................................19
>
> 9.2.2 NOTE
> 消息的发送............................................................................................22
>
> 9.2.3 IMAGE
> 消息的发送...........................................................................................25
>
> 10
> 主控接收消息过程...............................................................................................................25
>
> 11
> 一般消息处理过程................................................................................................................26
>
> 12
> 上下电过程..........................................................................................................................
> 27
>
> 13
> 录入过程..............................................................................................................................28
>
> 14
> 录入说明..............................................................................................................................29
>
> 15
> 解锁过程..............................................................................................................................30
>
> 16
> 防劫持功能说明...................................................................................................................30
>
> 17
> 加密通信过程.......................................................................................................................30
>
> 18 OTA
> 升级过程......................................................................................................................32
>
> 7、模块反馈
> OK；...................................................................................................................
> 32
>
> 19
> 补充说明..............................................................................................................................33
>
> 19.1
> ID_REPLY..................................................................................................................33
>
> 19.2
> ID_NOTE...................................................................................................................34
>
> 19.3
> ID_RESET.................................................................................................................35
>
> 19.4
> ID_GETSTATUS........................................................................................................35
>
> 19.5
> ID_VERIFY................................................................................................................35
>
> 19.6
> ID_ENROLL...............................................................................................................36
>
> 19.7
> ID_DELUSER............................................................................................................37
>
> 19.8
> ID_DELALL................................................................................................................37
>
> 19.9
> ID_GETUSERINFO...................................................................................................37
>
> 19.10
> ID_FACERESET.....................................................................................................
> 38
>
> 19.11
> ID_POWERDOWN..................................................................................................38
>
> 19.12
> ID_DEMOMODE.....................................................................................................38
>
> 19.13
> ID_SNAPIMAGE.....................................................................................................
> 38
>
> 19.14 ID_GETSAVDIMAGE &
> ID_UPLOADIMAGE.........................................................38
>
> 19.15 ID_CAPTURE &
> ID_UPLOADIMAGE.....................................................................39
>
> 19.16
> ID_CAPTURE_PIC_TYPE......................................................................................39
>
> 19.17
> ID_GET_ALL_USERID...........................................................................................39
>
> 19.18 ID_GET_LOGFILE
> &ID_UPLOAD_LOGFILE........................................................40
>
> 19.19
> ID_SET_RELEASE_ENC_KEY..............................................................................40

www.hzgrow.com

> <img src="./5542rksv.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> 19.20
> ID_INIT_ENCRYPTION..........................................................................................40
>
> 19.21
> ID_SET_THRESHOLD_LEVEL..............................................................................41
>
> 19.22
> ID_ENROLL_ITG....................................................................................................
> 41
>
> 19.23 ID_GET_FEATURE_INFO &
> ID_UPLOAD_FEATURE..........................................42
>
> 19.24 ID_TRANS_FILE_PACKET &
> ID_ENROLL_WITH_FEATURE.............................42
>
> 19.25 ID_TRANS_FILE_PACKET &
> ID_ENROLL_FROM_IMAGE.................................43

www.hzgrow.com

> <img src="./5p1i2eyv.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**1** 概述

> F900
> 人脸识别模组，具有功耗低、成本低、快速识别、外观靓丽、产品结构小巧精致等特点，

采用了高算力Giraffe AI Chip
芯片，使用自研最优人脸识别算法，算法性能优良，保证用户最佳体

验效果，可快速完成深度计算和人脸识别计算的完整过程，直接输出人脸识别结果。

> 本产品能快速准确获取目标的深度信息，针对不同区域，建立高频人脸库，减少用户二次确认

概率，有效提升识别效率。算法具备自学习能力，人脸识别会随使用次数不断提高，识别通过率高

达99.9%，认假率低于百万分之一，强光、暗光、逆光皆好用。

> 本产品芯片硬件底层搭载加密技术，防止照片、面具、视频等攻击作假，确保数据安全可靠。
>
> 本产品可广泛应用于智能门锁、门禁系统、终端刷脸设备等相关领域，能满足办公室、园区、

公寓等场所的3D 双目人脸识别能门锁、门禁系统、终端刷脸设备等应用需求。

> www.hzgrow.com 1
>
> <img src="./gktpzjis.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> **2** 产品介绍
>
> **2.1** 产品规格
>
> ⑴ F900 主要产品规格如下表2-1 所示。
>
> 表 2-1 F900 主要产品规格

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 2
>
> <img src="./lcdcrc4t.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> ⑵软件参数如下表2-2 所示。
>
> 表 2-2 F900 软件参数表

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> ⑶ 工作条件
>
>  外部供电电压和存储温度的绝对最大额定值如下表2-3 所示。

||
||
||
||
||
||

> 表 2-3 绝对最大额定值

推荐外部供电电压工作条件为5~12V，最小极限值为4.5V，最大极限值为13.5V。

> www.hzgrow.com 3
>
> <img src="./fvo0qks1.png"
> style="width:1.03833in;height:0.27833in" />F900
> 使用手册<img src="./jwe0a4ax.png" style="width:3.15in;height:1.28333in" /><img src="./mkinhtsw.png"
> style="width:2.76667in;height:1.37833in" />

**2.2** 模组框图

> 正反面示意图如下图2-1 所示。
>
> <img src="./swkun3v3.png"
> style="width:6.42833in;height:1.77167in" />图 2-1 模组框图

**2.3** 模组正反面示意图

> 正反面示意图如下图2-2 所示。
>
> 图 2-2 正反面示意图

**2.4** 产品组成

> 模组由双目摄像头模组和Giraffe AI Chip
> 核心计算板组成。具体描述如下表2-4 所示。

||
||
||
||
||
||
||
||
||

> 表 2-4 模组具体描述
>
> www.hzgrow.com 4
>
> <img src="./ceimx2p2.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**2.5** 模组管脚定义

> 2.5.1 通讯接口

默认波特率115200bps，不使用硬件/软件流控制，8 位数据位，1
位停止位，不使用奇偶校验 位。

> 2.5.2 管脚布局图
>
> F900 共有4 个管脚，管脚布局图如下图2-3 所示。
>
> <img src="./nkbj1e2a.png" style="width:4.54in;height:3.14167in" />接口间距：MX1.25\*4Pin
>
> 图 2-3 F900 管脚布局图
>
> 2.5.3 模组管脚定义
>
> ⑴模组管脚定义表如下表2-5 所示。
>
> 表 2-5 F900 管脚定义表

||
||
||
||
||
||
||

> www.hzgrow.com 5
>
> <img src="./hlqbv0mr.png"
> style="width:1.03833in;height:0.27833in" />F900
> 使用手册<img src="./5wmfwj03.png"
> style="width:6.44667in;height:3.54333in" /><img src="./23zjgaz1.png"
> style="width:2.52333in;height:1.96833in" />
>
> ⑵串口逻辑电平如下表2-6 所示。
>
> 表 2-6 串口逻辑电平

||
||
||
||
||

> 注：通过4
> 线串口，给本模组提供电源的时候，需要使用可以控制开启与关闭的外部电源。

**2.6** 模组结构图

> 2.6.1 双目摄像头板和核心计算板
>
> ⑴ F900 整个模组尺寸为 39.0mm x 14.5mm x 9.4mm。模组尺寸图如下图2-4
> 所示。
>
> 图 2-4 F900 尺寸图
>
> ⑵ F900 爆炸图如下图2-5 所示。
>
> 图 2-5 F900 爆炸图
>
> www.hzgrow.com 6
>
> <img src="./03l11iul.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**3** 功能描述

**3.1** 工作模式

> F900 模组有两种工作模式：
>
>  正常工作模式：Idle 软件正常运行。
>
>  关机模式：在此模式下，PMIC 停止给模块的电源供电。

**3.2** 电源设计

> ⑴ 引脚介绍
>
> F900 模组有VCC 引脚用于连接外部的UART 串口供电。
>
> ⑵ 减少电压跌落
>
> 模组的供电范围为 5V~12V，需要确保输入电压不低于 4.5V。
>
> <img src="./lp4veurx.png" style="width:4.96in;height:1.55in" />突发工作
> 突发工作
>
> ＜0.2V
>
> 图 3-1 模组供电电压

为了减少电压跌落，需要使用低ESR（ESR=0.7Ω，25V 以上耐压）的100μF
滤波电容。同 时建议分别给VIN 预留3 个具有最佳ESR
性能的片式多层陶瓷电容（MLCC，25V以上耐压）10uF、
100nF、100pF，且电容靠近VIN 引脚放置。外部供电电源连接模块时， VIN
需要采用星型走线。 VIN 走线宽度应不小于1mm。原则上，VIN
走线越长，线宽越宽。

> 另外，为了保证电源稳定，建议在电源前端加VRWM=12V，PPP=2550W 的 TVS
> 管。 VBUS
>
> VIN
>
> <u>D1</u> C1 C2 C3 C4 +
>
> VBUS
>
> VIN
>
> A31L

D2 <u>C5</u> C6 C7 C8 +

> 100uF 10uF 100nF 100pF 100uF 10uF 100nF 100pF
>
> 图 3-2 减少电压跌落
>
> www.hzgrow.com 7
>
> <img src="./nb5y5gzg.png"
> style="width:1.03833in;height:0.27833in" />F900
> 使用手册<img src="./yz2it0pw.png"
> style="width:3.49833in;height:1.96833in" /><img src="./4scthpiz.png"
> style="width:4.39833in;height:1.53667in" />
>
> 并建议增加一个过流保护电路，参考原理框图如下图3-3 所示：
>
> 图 3-3 过流保护电路参考原理图

**3.3** 开关机

> F900 模组采用直接上电下电模式。
>
> ⑴ 开机
>
>  开机时候，主控端输出开机信号给电源开关，打开电源开关给模组上电。
>
>  开机时序如下图3-4 所示：
>
> 图 3-4 开机时序图
>
>  说明：
>
> A：人脸模块上电
>
> B：人脸模块发送ready 信号给锁控
>
> C：锁控向人脸模组发出verify 指令
>
> D：锁控收到人脸模组verify 结果
>
> Ta: 520ms
>
> Tb: 典型测试场景50CM
> 测得数据700ms。该数据与测试距离和测试人脸配合有关， 最大不超过1100ms。
>
> ⑵ 关机
>
> 模块可通过发送控制命令关机的方式正常关机。
>
> www.hzgrow.com 8
>
> <img src="./pw5fssqs.png"
> style="width:1.03833in;height:0.27833in" />F900
> 使用手册<img src="./vp2mswpm.png" style="width:2.85in;height:3.93667in" />

**4** 安装

在固定F900
的摄像头模组时，使用机械结构压片来固定，保证在震动时不松动；摄像头和主
板使用锁螺丝固定，并避免摄像头模组变形，影响识别效果和精度。模组摄像头部分安装的高度和
安装角度，直接影响人脸解锁支持的身高。

> ⑴ 丝印与油墨设计：
>
>  开窗建议比镜头FOV 大7 度左右；
>
>  开窗处如果需要涂敷油墨，需要保证油墨在850nm
> 波段透过率大于90%，建议喷涂
> 增透膜提高透光率，并且保持喷面的平整度和洁净度。
>
> ⑵ 模组镜头安装角度：
>
> 摄像头模组安装时主光轴与水平夹角约为21°，摄像头的视场角度侧视图下图4-1
> 所示。
>
> 图 4-1 摄像头视场角度侧视图
>
> www.hzgrow.com 9
>
> <img src="./5gpko1fv.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**5** 注意事项


本产品属于精密装置，避免碰撞、跌落、震动，以免主板器件脱落或镜头内部损坏，导致出现

> 功能或性能问题。

 装有本产品的设备避免在阳光下使用，推荐在室内或无太阳光的地方使用。


本产品运输过程中采用气泡袋或者珍珠棉包裹保护，且需要避免手、灰尘、水渍等接触。

 如果摄像头部分需覆盖玻璃盖板，要求玻璃的全光谱通光率大于95%以上。

> www.hzgrow.com 10
>
> <img src="./wtabzt4b.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**6** 通讯接口

模组和主控之间采用串口方式通信。默认波特率为115200bps，支持常见的波特率。不使用硬
件/软件流控。8 位数据位和1 位停止位，无奇偶校验位。

**7** 指令格式详解

**7.1** 指令基本格式

> 主控与模块通信的基本消息格式如下表2-1 所示。
>
> 表 2-1 指令基本消息格式

||
||
||
||
||

>  包头是固定的消息开头同步字0xEFAA。
>
>  消息ID 是各种类型的消息ID。
>
>  数据长度是消息数据的长度。
>
>  消息数据是消息对应的data，长度为N bytes，0\<=N\<65535，当N=0
> 时表示此消息无数
>
> 据部分。
>
>  校验码是从消息ID 到校验码之间所有字节按位做XOR 运算（包括消息ID
> 的字节）。
>
>  对于多字节的高字节在前低字节在后（如 2 bytes 的 00 06 表示
> 0006，而不是 0600）。
>
> www.hzgrow.com 11
>
> <img src="./abufkuyy.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> **8** 通信消息详解
>
> **8.1** 通信消息类型
>
> 模块(M)和主控(H)的所有通信消息类型都包含消息ID
> 和消息data，通讯消息类型如下表3-1 所示。
>
> 表 3-1 通信消息类型

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 12
>
> <img src="./2qou2fre.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> 大多数消息处理都对应有 timeout 超时时间定义，timeout
> 指的是主控等待模块处理的最长时
> 间，即模块处理主控命令的最长时间。当指令处理超时，主控可采用如下几种处理方式:
>
> www.hzgrow.com 13
>
> <img src="./ppaea1d1.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
>  发送 ID_GETSTATUS
> 指令：此消息能快速获取模块的工作状态，若死机则无返回，主控
>
> 可直接断电。
>
>  发送 RESET 指令：停止所有当前的处理，模块进入 standby
> 的状态，等待主控新的指
>
> 令。
>
>  认为模块死机：主控可采用断电重启的处理方式。
>
> **9** 指令详解
>
> **9.1** 消息接收指令**(H**→**M)**
>
>  功能说明：主控应该按照模块消息接收的完整协议格式向模块发送命令。
>
>  指令包格式：
>
> 表 4-1 模块消息接收的完整协议格式

||
||
||
||
||

>  辅助说明：
>
>  数据长度是消息数据的长度。
>
>  消息ID 命令内容和data 的定义如下表4-2 所示。
>
> 表 4-2 消息ID 命令和data 的定义

||
||
||
||
||
||
||
||
||

> www.hzgrow.com 14
>
> <img src="./dtiimycp.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 15
>
> <img src="./soszxq1e.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 16
>
> <img src="./ihaffyq0.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 17
>
> <img src="./5k2yincg.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||

>  人脸方向定义如下表4-3 所示。
>
> 表 4-3 人脸方向定义

||
||
||
||
||
||
||
||
||

>  示例：
>
> 主控发送给模块的RESET 消息：EF AA 10 00 00
> 10，数据长度为0，不携带消息数据，如下 表4-4 所示。
>
> 表 4-4 主控发送给模板RESET 消息示例

||
||
||
||

> **9.2** 消息发送指令**(M**→**H)**
>
> 模块主要发送三种类型的消息，分别是 REPLY，NOTE，IMAGE。
>
> www.hzgrow.com 18
>
> <img src="./25xvumsm.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> 9.2.1 **REPLY** 消息的发送
>
>  功能说明：模块向主控发送REPLY 消息。
>
>  指令包格式：
>
> 表 4-5 模块向主控发送的REPLY 消息的完整协议格式

||
||
||
||
||
||
||

>  辅助说明：
>
>  该消息ID 定义为ID_REPLY ，命令码为0x00，所对应的消息数据的结构是
>
> s_msg_reply_data。
>
>  数据长度只包括消息数据的所有字节数。
>
>  参数1 表示本消息是对主控哪一条消息ID 命令的响应，例如当参数
>
> 1=ID_ENROLL(0x13)时，表示该消息是模块处理完enroll
> 任务后回复的消息。参数1 定义如下表4-6 所示。
>
> 表 4-6 参数1 定义

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 19
>
> <img src="./5w4x4gne.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 20
>
> <img src="./bbpifnfh.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||
||

> 确认码定义
>
> 确认码表示该命令的执行结果，确认码定义如下表4-7 所示。 表 4-7
> 确认码定义

||
||
||
||
||
||
||
||
||
||
||

> www.hzgrow.com 21
>
> <img src="./cxoywcrn.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||

>  示例：
>
> 模块向主控发送的REPLY 消息：EFAA00 00 04 13 00 00 01
> 16，该消息表示模块处理完enroll 任务回复后给主控的 REPLY
> 消息，数据长度为4 个字节，录入成功且录入的用户 ID 是0x0001， 如下表4-8
> 所示。
>
> 表 4-8 REPLY 消息发送的示例

||
||
||
||
||
||

> 9.2.2 **NOTE** 消息的发送
>
>  NOTE 消息主要作用是主动向主控返回一些信息，目前 NOTE
> 消息主要在三种情况下发
>
> 送：
>
>  开机时模块向主控发送 NID_READY；
>
>  录入过程中模块向主控发送人脸状态信息；
>
>  解锁过程中模块向主控发送人脸状态信息。
>
>  功能说明：模块向主控发送NOTE 消息。
>
>  指令包格式：
>
> 表 4-9 模块向主控发送的NOTE 消息的完整协议格式

||
||
||
||
||
||
||

>  辅助说明：
>
>  该消息ID 的定义为ID_NOTE，命令码为0x01，所对应的消息数据的结构是
>
> s_msg_note_data。
>
> www.hzgrow.com 22
>
> <img src="./vqbnfndn.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
>  数据长度只包括消息数据的所有字节数。
>
>  参数1 定义如下表4-10 所示。
>
> 表 4-10 参数1 定义

||
||
||
||
||
||
||
||

> NID_FACE_STATE\*所携带的参数2 的详细定义如下表4-11 所示。
>
> 表 4-11 参数2 定义

||
||
||
||

> www.hzgrow.com 23
>
> <img src="./l00b4nq5.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

||
||
||
||
||
||
||
||
||
||
||

> <img src="./tvt22pjh.png" style="width:4.64in;height:2.9in" />
> Yaw,Pitch,Roll 旋转方向如下图4-1 所示。
>
> 图 4-1 Yaw,Pitch,Roll 的旋转方向示意图  示例
>
> 模块向主控发送的NOTE 消息：EF AA 01 00 01 00
> 00。该消息表示这是模块向主控发送的 NOTE
> 消息，模块已经准备好接收其他命令，数据长度为1
> 字节。各个字段对应关系如表4-12 所 示。
>
> 表 4-12 NOTE 消息发送的示例

||
||
||
||
||
||

> www.hzgrow.com 24
>
> <img src="./ielkex1x.png"
> style="width:1.03833in;height:0.27833in" />F900
> 使用手册<img src="./n0rowtwd.png"
> style="width:6.65333in;height:5.00833in" />
>
> 9.2.3 **IMAGE** 消息的发送
>
>  功能说明：模块向主控发送 IMAGE 消息。
>
>  指令包格式：
>
> 表 4-13 模块向主控发送的IMAGE 消息的完整协议格式

||
||
||
||
||

>  辅助说明：
>
>  该消息ID
> 的定义为ID_IMAGE，命令码为0x02，所对应的消息数据的结构是image。
>
>  数据长度是消息数据的长度。
>
>  F900 模块传输图片时，一帧数据最大支持 4000 字节数据的传输。

**10** 主控接收消息过程

> 主控接收模块的消息过程如下图5-1 所示。
>
> 图 5-1 功能实现示例1：主控接收消息过程
>
> www.hzgrow.com 25
>
> <img src="./npvxcln3.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**11** 一般消息处理过程

> 一般消息处理过程如下图6-1 所示。
>
> <img src="./qhqvqqy5.png"
> style="width:0.85071in;height:0.33976in" /><img src="./350wwzwp.png"
> style="width:0.84997in;height:0.3471in" />主控 人脸模块
>
> Msg：XXXCMD 模块等待主控指令
>
> 主控等待指令 模块处理主控 的处理结果 Msg：XXXCMD Done 的请求
>
> …
>
> 主控等待指令的处理结果超时， 主控发送GETSTATUS 指令，如 果200ms
> 无返回说明模块死机， 主控断电重启，如果有返回主控
> 可选择继续等待，CANCEL 再处
>
> 理消息或RESET
>
> Msg：XXXCMD
>
> 模块处理主控

Msg：ID_GETSTATUS 的请求

> 图 6-1 功能实现示例2：一般消息处理流程
>
> www.hzgrow.com 26
>
> <img src="./kqdnz3zf.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**12** 上下电过程

主控主动控制模块的上电和下电，模块上电即进入启动流程， 启动进入 standby
状态，会通 知主控
MSG::NOTE::READY，主控开始发送命令消息，模块处理并返回结果。无消息发送时，主
控调用MSG::POWERDOWN，模块处理并返回结果，主控可断电。流程如下图7-1
所示。

> <img src="./nx0o0qg3.png"
> style="width:0.84444in;height:0.35458in" /><img src="./dowvitee.png"
> style="width:0.90947in;height:0.37438in" /><img src="./bh51ruik.png"
> style="width:1.94037in;height:0.42126in" />主控 人脸模块
>
> 主控给模块上电
>
> Msg：NOTE：READY
>
> Msg：XXXCMD
>
> Msg：XXXCMD Done

关机断电状态

> AivaLock 上电自启动
>
> 初始化并等待指控指令

模块处理主控的请求

> 主控接收到消息后等
>
> 待100ms 断电
>
> …
>
> Msg：ID_POWERDOWN
>
> Msg：EPLY：

ID_POWERDOWN Done

模块做好断电前的

准备并关机

> 图 7-1 功能实现示例3：上下电流程
>
> www.hzgrow.com 27
>
> <img src="./3ikknhal.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**13** 录入过程

在录入过程中，人脸模块不限制录入方向的顺序，用户可以任意组合录入方向的顺序。如下图
8-1
是以其中一种顺序为例的录入流程，该人脸录入方向的顺序：正向→朝上→朝下。

> <img src="./b04bq15p.png"
> style="width:0.85479in;height:0.35075in" /><img src="./aqkfscei.png"
> style="width:0.85404in;height:0.35833in" />主控 人脸模块
>
> 主控发送enroll 命令， 并传入用户名、录入方
>
> 向、超时等信息

模块等待主控指令 Msg：ID_ENROLL:MIDDLE

> Msg：NOTE:face_data
>
> Msg：REPLY:enroll_result
>
> Msg：ID_ENROLL:UP
>
> Msg：NOTE:face_data
>
> Msg：REPLY:enroll_result
>
> Msg：ID_ENROLL:DOWN
>
> Msg：NOTE:face_data

模块处理主控的请求，根据

主控发送消息中的人脸方

向录入，录入过程中会返回

人脸的状态、位置、姿态，

录入完毕后会返回录入的

结果。

> Msg：REPLY:enroll_result
>
> …
>
> 图 8-1 功能实现示例4：以正向→朝上→朝下为人脸录入顺序的录入流程

当主控下达录入某个方向的人脸的指令后，模块开始工作，并以 NOTE
消息的形式实时返回
人脸的状态、位置、姿态等信息，用户可根据该信息提醒录入人进行姿态位置的调整，当录入成功
后，模块将以 REPLY
消息的形式返回录入结果，如果录入不成功，模块也会相应地返回失败的原 因。

> 注：
>
>  当模块拿到的第一帧图片就录入成功时，将直接以 REPLY
> 消息的形式返回结果。录
>
> 入过程中可通过 FACE RESET 指令终止录入,先前的录入状态也会清零。
>
>  如果在录入过程中突然断电，之前录入的人脸也不会保存。
>
> www.hzgrow.com 28
>
> <img src="./z1enscmw.png"
> style="width:1.03833in;height:0.27833in" />F900
> 使用手册<img src="./p30ddsse.png"
> style="width:1.64167in;height:0.72833in" /><img src="./qugasbpz.png"
> style="width:1.59833in;height:0.83833in" /><img src="./f0nbjmp0.png"
> style="width:1.57667in;height:0.76667in" /><img src="./1sqa1yso.png"
> style="width:0.70667in;height:0.67167in" /><img src="./mbv2bm3a.png"
> style="width:0.63335in;height:0.60708in" />

**14** 录入说明

>  人脸录入各个方向的角度说明如下表9-1 所示。
>
> 表 9-1 人脸录入各个方向的角度说明

||
||
||
||
||
||
||
||

>  人脸录入各个方向偏转示意图如下所示。
>
>  向上和向下偏转如图9-1 所示。
>
> 图 9-1 向上和向下偏转
>
>  向左和向右偏转如图 9-2 所示。
>
> 图 9-2 向左和向右偏转
>
>  注：
>
>  请不要采用如下图 9-3 所示的转头方式。
>
> 图 9-3 错误转头方式
>
> 
> 在人脸录入的过程中，头部向某个方向转向，并且保持匀速，不要转头角度过大，或
>
> 者转头或者速度过快。
>
> www.hzgrow.com 29
>
> <img src="./juyute4d.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**15** 解锁过程

> 解锁过程如下图10-1 所示。
>
> <img src="./kkye0azl.png"
> style="width:0.81989in;height:0.34636in" /><img src="./qx54icai.png"
> style="width:0.81919in;height:0.35383in" />主控 人脸模块
>
> 主控发送鉴权解锁 Msg：ID_VERIFY 模块等待主控的命令 命令
>
> Msg：NOTE:face_data
>
> Msg：NOTE:face_data
>
> …
>
> Msg：REPLY:verify_result

模块处理主控的请求，进入解锁

流程，期间会实时地返回人脸的

状态、位置、姿态等信息，用户

可根据该信息提示解锁人调整姿

态、位置。解锁成功后返回解锁 人的ID，name,admin 等信息，

解锁不成功会返回相应的原因。

> 图 10-1 功能实现示例5：解锁流程

**16** 防劫持功能说明

在图10-1
解锁过程中，如果模块检测到闭眼状态，立即返回闭眼状态并且进入睁闭眼检测模
式，在接下来的一秒内持续检测：

>  如果在一秒内检测到睁眼状态，则判断为正常解锁；
>
>  如果在一秒内检测到至少有一帧图像是闭眼状态，则判定为被劫持；
>
>  如果在一秒内既没有检测到睁眼也没有检测到闭眼的状态，则返回未知状态。
>
> 在睁闭眼模式检测都是通过 note 发送消息通知主控人脸状态。

**17** 加密通信过程

> 加密详细过程请参考《人脸识别锁模组》
>
>  加密通信过程的步骤如下：
>
> 1、主控给模组上电；
>
> www.hzgrow.com 30
>
> <img src="./vlvhjs23.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> 2、模组发送 READY（明文）给主控；
>
> 3、模组第一次开机需要调用 ID_SET_RELEASE_ENC_KEY 指令设置16bytes
> 序列作为
>
> 密钥的生成规则；
>
> 4、主控采用随机数生成随机序列并发送给模组（4bytes）。模组和主控双方根据这随机序
> 列 ，采用步骤3 中 16Bytes 规则生成 16bytes
> 的密码。双方采用相同算法生成相同
> 的密码。之后双方本次会话都采用此密码加解密；
>
> 5、F900 模组返回状态并采用随机密码 AES 加密发送产品序列号给主控；
>
> 6、主控解密，鉴别设备 ID 确认身份后开始处理需求指令，录入或解锁等；
>
> 7、主控采用随机生成的密码， AES
> 加密的方式对指令和数据加密并发送给模组；
>
> 8、模组用第 4 步解密出来的密码解密，判断指令合法性并处理该指令；
>
> 9、模组用第 4 步解密出来的密码对指令处理结果和数据加密，并发送给主控。
>
>  加密通信过程的流程如下图12-1 所示：
>
> AIVA 主控 READY
>
> 启动加密通信
>
> 发送随机序列
>
> 双方根据随机序列采用协定的相同算法生成
>
> 随机密码

设备鉴权OK后开

始发送指令通讯

> 加密发送设备唯
>
> 一标识ID 给主控
>
> 加密通讯 对称加密（指令）
>
> 对称加密RESULT
>
> 图 12-1 功能实现示例6：加密通信流程

www.hzgrow.com 31

> <img src="./te0omcoe.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**18** **OTA** 升级过程

> OTA 升级过程步骤如下：
>
> 1、主控发送
> ID_START_OTA（加密通信）通知人脸识别模块（以下简称模块）进入 OTA
>
> 模式；
>
> 2、模块反馈 OK（不加密通信，后面的都是不加密模式），表示进入了OTA
> 模式；
>
> 3、主控发送 ID_CONFIG_BAUDRATE 配置更高波特率，模块反馈OK
> 后，主机同步设 置相同波特率，延时 100ms
> 后才能开始串口数据传输（该配置过程可选，波特率默 认是 115200）；
>
> 4、主控发送 ID_GET_OTA_STATUS；
>
> 5、模块反馈 OTA 状态和起始包序号；
>
> 6、主控发送 ID_OTA_HEADER，把固件相关信息发送到模块；
>
> 7、模块反馈 OK；
>
> 8、主控循环发送升级包ID_OTA_PACKET，收到 OK 后，继续下一包；
>
> 9、模块收完固件后，开始升级；
>
> 10、模块升级结束反馈 NID_OTA_DONE。
>
> 具体流程参照：“智能人脸模组 OTA 方案软件工作流程.pdf”。
>
> www.hzgrow.com 32
>
> <img src="./qdkhbj2k.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**19** 补充说明

**19.1** **ID_REPLY**

主控发送给模块的每条命令，最终都会收到模块的 ID_REPLY
回复，该消息包含主控发送的
消息ID（参数1），命令的执行结果确认码，以及可能返回的消息data（参数2）。

> typedef struct {

uint8_t mid; // the command(message) id to reply (the request message
ID)

uint8_t feat_size\[4\];//command handling result: success or failed
-\>s_msg_result

> uint8_t data\[0\]; //参数2
>
> } s_msg_reply_data;
>
> 命令的执行结果 result（确认码） 可能是以下几种情况：
>
> /\* message result code \*/
>
> typedef enum \_s_msg_result
>
> {
>
> MR_SUCCESS
>
> MR_REJECTED
>
> MR_ABORTED
>
> MR_FAILED4_CAMERA
>
> MR_FAILED4_UNKNOWNREASON
>
> MR_FAILED4_INVALIDPARAM
>
> MR_FAILED4_NOMEMORY
>
> MR_FAILED4_UNKNOWNUSER
>
> MR_FAILED4_MAXUSER
>
> MR_FAILED4_FACEENROLLED
>
> MR_FAILED4_LIVENESSCHECK
>
> MR_FAILED4_TIMEOUT
>
> MR_FAILED4_AUTHORIZATION
>
> MR_FAILED4_CAMERAFOV
>
> MR_FAILED4_CAMERAQUA
>
> www.hzgrow.com
>
> =0,// success
>
> =1,//modulerejectedthiscommand
>
> =2,// algo aborted
>
> =4,// camera open failed
>
> =5,// unknown_error
>
> =6,// invalid param
>
> =7,// no enough memory
>
> =8,// unknown user
>
> =9,// exceed maximum user number
>
> =10,//thisfacehasbeenenrolled
>
> =12,// liveness check failed
>
> =13,// exceed the time limit
>
> =14,// authorization failed
>
> =15,// camera fov test failed
>
> =16,// camera quality test failed

33

> <img src="./4qtrdqhs.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

MR_FAILED4_CAMERSTRU =17,// camera structure test failed

> MR_FAILED4_BOOT_TIMEOUT
>
> MR_FAILED4_READ_FILE
>
> MR_FAILED4_WRITE_FILE
>
> MR_FAILED4_NO_ENCRYPT
>
> } s_msg_result_t;
>
> /\* message result code \*/

=18,// boot up timeout

> =19,// read file failed

=20,// write file failed

=21,// encrypt must be set

返回的data（参数2）根据id（参数1）而有所不同，在头文件message.h
中，以“s_msg_reply\_” 开头的结构体都是各个指令发送reply
消息时所携带的消息data，以verify 命令为例：

> /\* message reply data definitions \*/
>
> typedef struct {
>
> uint8_t user_id_heb;
>
> uint8_t user_id_leb;
>
> uint8_t user_name\[USER_NAME_SIZE\];
>
> uint8_t admin;
>
> } s_user_info_data;
>
> typedef struct {
>
> s_user_info_data user_info;
>
> uint8_t unlock_status; /\* s_unlock_status \*/
>
> } s_msg_reply_verify_data;

**19.2** **ID_NOTE**

MSG::NOTE
消息为模块向主控主动上报的信息，例如当模块上电后会主动向主控发送一条
NOTE，表明自己已经 READY，可以接收主控的命令，主控收到该 NOTE
消息后即可开始发送录 入或者解锁命令。

> NOTE 消息中所包含的数据为： typedef struct {
>
> uint8_t nid; //参数1
>
> uint8_t data\[0\];
>
> } s_msg_note_data;
>
> www.hzgrow.com 34
>
> <img src="./zrmcrw0o.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**19.3** **ID_RESET**

主控发送这条命令后，模块将取消之前正在执行的命令（例如录入、解锁等），返回
STANDBY 状态。

**19.4** **ID_GETSTATUS**

> 主控发送该命令后，模块返回自身当前的状态，主要包括：
>
>  MS_STANDBY(0): 模块处于空闲状态，等待主控命令
>
>  MS_BUSY(1): 模块处于工作状态
>
>  MS_ERROR(2): 模块出错，不能正常工作
>
>  MS_INVALID(3): 模块未进行初始化

**19.5** **ID_VERIFY**

> MSG::VERIFY 为最常用功能，其携带的 data 如下：
>
> // verify
>
> typedef struct {
>
> uint8_t pd_rightaway;
>
> uint8_t timeout;
>
> } s_msg_verify_data;
>
> //power down right away after verifying

//timeout,unit second,default 10s

\[pd_rightaway\]表示是否在解锁后立刻关机；\[timeout\]为解锁超时时间（单位s），默认为
10s， 可以在发送解锁命令时设置，超时时间用户可以任意设定，最大不超过
255s。

解锁过程中，模块可能返回 NOTE 消息，命令执行完会发送 REPLY 消息。NOTE
主要返回 的是当前帧图片中人脸的状态，如人脸位置和姿态。 REPLY
主要返回的是解锁过程执行完毕后的
最终结果，可能返回的确认码包括：MR_SUCCESS，MR_FAILED4_NOSUCHFACE，
MR_ABORTED 等，详见表 4-7。当返回的确认码是 MR_SUCCESS
时，表示解锁成功。REPALY
携带的数据表明是什么样的方式解锁，睁眼或者闭眼。数据结构如下：

> typedef struct {
>
> s_user_info_data user_info;
>
> uint8_t unlock_status; /\* s_unlock_status \*/
>
> } s_msg_reply_verify_data;
>
> 其中\[unlockStatus\]代表开锁时的睁闭眼状态，定义如下： typedef enum {
>
> www.hzgrow.com 35
>
> <img src="./1ldw5qv0.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> UNLOCK_NORMAL = 200,
>
> UNLOCK_WITH_EYES_CLOSE = 204,
>
> } s_unlock_status;

**19.6** **ID_ENROLL**

> MSG::ENROLL 也是比较常用的功能，其附带的消息data 如下: // enroll user
>
> typedef struct {
>
> uint8_t admin; //the user will be set to admin
>
> uint8_t user_name\[USER_NAME_SIZE\];
>
> s_face_dir face_direction;
>
> uint8_t timeout; //timeout,unit second default 10s
>
> } s_msg_enroll_data;

\[admin\]指明该录入的人为管理员；\[timeout\]为录入过程中的超时时间（单位s），默认为
10s， 可以在发送录入命令时设置，超时时间用户可以随意设置，最大不超过
255s；\[face_direction\]表示 用户要录入的人脸方向，有效的人脸方向有 5
种，定义如下：

> /\* msg face direction \*/
>
> typedef uint8_t s_face_dir;
>
> \#define FACE_DIRECTION_UP
>
> \#define FACE_DIRECTION_DOWN
>
> \#define FACE_DIRECTION_LEFT
>
> \#define FACE_DIRECTION_RIGHT
>
> \#define FACE_DIRECTION_MIDDLE
>
> \#define FACE_DIRECTION_UNDEFINE
>
> /\* msg face direction end \*/

(1 \<\< 4) // face up

> (1 \<\< 3) // face down
>
> (1 \<\< 2) // face left
>
> (1 \<\< 1) // face right
>
> (1 \<\< 0) // face middle
>
> 0x00 // face undefine
>
> 录入过程中可能会返回 NOTE 消息，录入结束会返回REPLY 消息。
>
> NOTE 主要返回的是当前帧图片中人脸的状态，以及人脸位置和姿态。

REPLY 主要返回录入过程执行完毕后的最终结果，可能返回的确认码详见表
4-7。当返回 MR_SUCCESSS 时，表示录入成功。REPLY
同时也会携带一些信息返回，如下所示：

> typedef struct {
>
> uint8_t user_id_heb;
>
> uint8_t user_id_leb;
>
> www.hzgrow.com 36
>
> <img src="./lo5lffne.png"
> style="width:1.03833in;height:0.27833in" />F900
> 使用手册<img src="./sv2jk0g4.png"
> style="width:4.34667in;height:1.50833in" />
>
> uint8_t face_direction;
>
> } s_msg_reply_enroll_data;

其中\[face_direction\]表示人脸录入状态，数据的低 5
位从高到低分别表示人脸方向的朝上、朝 下、朝左、朝右和正向，如下图14-1
所示，1 表示该朝向已录入，0 表示该朝向未录入。

> 图 14-1 人脸录入状态

**19.7ID_DELUSER**

> MSG::DELUSER 为删除一个已注册的用户，通过 user_id 指定。

**19.8** **ID_DELALL**

> MSG::DELALL 为删除所有注册的用户信息。

**19.9** **ID_GETUSERINFO**

主控通过 user id
指定要返回的注册用户，模块接收到该命令后会返回指定用户的信息，主要
包括以下信息：

> /\* message reply data definitions \*/
>
> typedef struct {
>
> uint8_t user_id_heb;
>
> uint8_t user_id_leb;
>
> uint8_t user_name\[USER_NAME_SIZE\];
>
> uint8_t admin;
>
> } s_user_info_data;
>
> typedef s_user_info_data s_msg_reply_getuserinfo_data;
>
> www.hzgrow.com 37
>
> <img src="./1wgn4chb.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**19.10** **ID_FACERESET**

> MSG::FACERESET 消息为重置 SDK
> 算法状态，如果正在进行交互式录入，发送此消息会重

置录入的状态，已录入的方向全部被清空。

**19.11** **ID_POWERDOWN**

主控给模块断电前需先发送 ID_POWERDOWN
命令，模块收到该命令后进行相应的断电处理
操作，并给主控返回应答消息，主控收到 REPLY 消息后需等待 100ms
再断电，强制断电可能会
对硬件造成损害。在该消息中，系统会将本次开机的操作记录写入文件系统中，为了售后方便获取
问题 log，该消息在断电之前必须调用。

**19.12** **ID_DEMOMODE**

> 主控发送该命令后，模块进入演示模式，这种模式下模块鉴权的流程中将不做特征比对，即所

有人都可以解锁，但是仍然会进行活体检测。

**19.13** **ID_SNAPIMAGE**

该命令为图片抓拍，主控下达该指令，并携带需抓拍图片的数量以及抓拍图片的起始编号后，
模块会立刻进行抓拍，将抓拍到的图片按照起始编号依次向后命名并存于本地(jpg
格式)。该功能最 大支持本地存储的图片数量为 20 张，图片编号为
1-20，当主控发送的编号与本地图片编号重复时， 将覆盖原始图片。

> /\* message reply data definitions \*/
>
> typedef struct {
>
> uint8_t image_counts;
>
> uint8_t start_number;
>
> } s_msg_snap_image_data;

// 需要抓拍的数量

// 抓拍图片的起始编号

**19.14** **ID_GETSAVDIMAGE** **&** **ID_UPLOADIMAGE**

抓拍的图片将存储在模组本地路径下，主控获取抓拍图片时，首先调用ID_GETSAVEDIMAGE
命令获取待上传图片的大小，然后根据需求分多次调用ID_UPLOADEIMAGE
来获取图片。 ID_UPLOADEIMAGE 指令中携带的数据
upload_image_offset\[4\]表示该次上传图片的偏移量（例 如偏移量位 0
时将从图片开头开始传输），upload_image_size\[4\]表示该次上传图片的大小，最大
支持 4000 字节。

> www.hzgrow.com 38
>
> <img src="./jyadcmjx.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> typedef struct {
>
> uint8_t image_number; // picture number to be captured
>
> } s_msg_get_saved_image_data;

**19.15** **ID_CAPTURE** **&** **ID_UPLOADIMAGE**

> ID_CAPTURE 获取最近一次注册或者识别的抓拍图片大小（Bytes） typedef
> struct {
>
> uint8_t image_size\[4\]; // image size, int -\> \[s1 s2 s3 s4\]
>
> } s_msg_reply_capture_data;

得到图片大小之后，可以分多次调用ID_UPLOADEIMAGE 来获取图片
ID_UPLOADEIMAGE 指令中携带的数据
upload_image_offset\[4\]表示该次上传图片的偏移量（例如偏移量位 0
时将从图
片开头开始传输），upload_image_size\[4\]表示该次上传图片的大小，最大支持
4000 字节。

ID_CAPTURE 与ID_SNAPIMAGE 的区别在于，ID_SNAPIMAGE
命令是主动要求摄像头抓拍 一张新图片，而ID_CAPTURE
是将最近一次注册或识别的数据读取出来（在注册和识别过程中，
会自动将最后注册或识别成功的图片暂时保存到内存中，直到下一次用户的有效操作才会进行释放）。

**19.16** **ID_CAPTURE_PIC_TYPE**

该命令主要作用为修改抓拍图片的参数，可修改参数包括分辨率，图片类型（IR
图还是RGB
图），图片压缩比率，是否裁剪人脸等。命令发送后，下一次模组抓拍的图片会以刚才命令参数中

的新格式保存后传回主控。 typedef struct {

> uint8_t pic_width\[2\];
>
> uint8_t pic_height\[2\];
>
> uint8_t capture_type;
>
> uint8_t compress_ratio;

80%:0xb

> uint8_tis_cutout_face;
>
> // capture picture width,int -\> \[b1, b2\]
>
> // capture picture height,int -\> \[b1, b2\]
>
> // capture type -\> IR:0x0 RGB:0x1
>
> // output picture compress ratio
>
> //quality30%:0x6;quality50%:0x8;quality

//outputpictureiscutoutfacepartionornot

> } s_msg_get_saved_image_data;

**19.17** **ID_GET_ALL_USERID**

> 获取所有已注册用户的数量和所有已注册用户的ID。
>
> www.hzgrow.com 39
>
> <img src="./ovrjxdtm.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**19.18** **ID_GET_LOGFILE** **&ID_UPLOAD_LOGFILE**

获取日志，通过 ID_GET_LOGFILE 指令中携带的参数来选择获取 APP的日志还是
kernel 的 日志，ID_UPLOAD_LOGFILE
用于实际将日志上传给主控，这两条指令的使用方式与 ID_GETSAVDIMAGE &
ID_UPLOADIMAGE 的使用方式完全相同，请参考。

> 此处需注意：上传上来的 log 文件是一个 tar 包，
> 需要先解包再查看里面的内容。

**19.19** **ID_SET_RELEASE_ENC_KEY**

主控在第一次开机时必须发送该命令，模块会对该指令携带的数据加密并保存，之后模块会用
该数据进行 14.20 中所描述的加密通信。该数据掉电不丢失。

> typedef struct {
>
> uint8_t enc_key_number\[16\];
>
> } s_msg_enc_key_number_data;

**19.20** **ID_INIT_ENCRYPTION**

主控下发启动加密命令，模块在该命令后生成密码，本命令的 reply
消息和后续通信均是加密 格式。

启动加密命令数据结构体中除了随机数外，还包含加密
mode。主控下发的启动加密命令数据 结构体如下：

> // MID_INIT_ENCRYPTION data
>
> typedef struct {
>
> uint8_t seed\[4\];
>
> uint8_t mode;
>
> uint8_t crttime\[4\];
>
> // random data as a seed

// reserved for selecting encrytion mode

> } s_msg_init_encryption_data;
>
> 模块响应的数据结构体如下：
>
> // MID_INIT_ENCRYPTION reply
>
> typedef struct {
>
> uint8_t device_id\[20\]; // the unique ID of this device, string type
>
> } s_msg_reply_init_encryption_data;
>
> www.hzgrow.com 40
>
> <img src="./1hcgysnl.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

**19.21** **ID_SET_THRESHOLD_LEVEL**

该接口用于修改算法安全等，
在不同厂商的与用户的理解中，由于安全要求标准不一致，所以
开放该接口用于设置liveness 和verify 的安全阈值，其中0-4
分别代表：低、较低、正常、较高、 高，默认值为2 正常。

> 主控下发结构体如下： typedef struct {

uint8_t verify_threshold_level;// level 0~4,safety from low to
high,default 2

uint8_t liveness_threshold_level;// level 0~4,safety from low to
high,default 2

> } s_msg_algo_threshold_data;

声明：推荐使用默认设置，安全等级过高易导致通过率降低；
安全等级过低易导致误识问题， 请慎用该设置。

**19.22** **ID_ENROLL_ITG**

> MSG::ENROLL_ITG 集成支持并扩展所有录入方式，其附带的消息data 如下: //
> integrated enrollment
>
> typedef struct {

uint8_tadmin; //the userwillbe setto admin:1- admin, 0 - normal user

> uint8_t user_name\[USER_NAME_SIZE\];
>
> uint8_t face_direction;
>
> /\* 0 - interactive, 1 - single \*/
>
> uint8_t enroll_type;

uint8_tenable_duplicate;//0 -disableuserduplicate,1 -enable user
duplicate

> uint8_t timeout; //timeout unit second, default 10s
>
> } s_msg_enroll_itg;

\[admin\]指明该录入的人为管理员；\[timeout\]为录入过程中的超时时间（单位s），默认为
10s， 可以在发送录入命令时设置，超时时间用户可以随意设置，最大不超过
25s；\[enroll_type\]选择录入 方式（0 表示交互式录入，1
表示单张录入）；\[enable_duplicate\]是否允许用户重复录入（0 表示禁

> www.hzgrow.com 41
>
> <img src="./mi1d51wz.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

止用户重复录入，1
表示允许用户重复录入）；\[resv\]目前暂不使用；\[face_direction\]表示用户要录
入的人脸方向，有效的人脸方向同14.6 ID_ENROLL。

**19.23** **ID_GET_FEATURE_INFO** **&** **ID_UPLOAD_FEATURE**

> 本组命令使用方法与 14.15 中的ID_CAPTURE & ID_UPLOADIMAGE 命令组类似。
>
> ID_GET_FEATURE_INFO
> 命令可以通过输入已知的注册用户的ID，获取存在数据库中此ID

对应的特征信息的大小。 typedef struct {

> uint8_t feat_size\[4\]; // feature size, int -\> \[s1 s2 s3 s4\]
>
> } s_msg_reply_get_face_feature;

得到特征信息大小之后，可以分多次调用ID_UPLOAD_FEATURE 来获取特征文件。
ID_UPLOAD_FEATURE 指令中携带的数据
upload_feature_offset\[4\]表示该次上传特征信息的的 偏移量（例如偏移量为
0 时将从特征文件开头开始传输），upload_feature_size\[4\]表示该次上传特
征文件的大小，最大支持 4000 字节。

**19.24** **ID_TRANS_FILE_PACKET** **&** **ID_ENROLL_WITH_FEATURE**

在使用特征注册指令前，需要先使用 14.23
所述的组合命令得到特征文件，得到特征文件后，
即可使用此特征文件进行注册。

> 用特征注册的第一步需要先下发特征文件，接受文件数据的结构体如下：
>
> typedef struct {
>
> uint8_t store_tyep;
>
> uint8_t feat_size\[4\];
>
> uint8_t offset\[4\];
>
> uint8_t psize\[2\];
>
> uint8_t data\[0\];
>
> } s_msg_trans_file_data;

// must be 0, store in memory

// transfer file size, int -\> \[s1 s2 s3 s4\]

// transfer file offset

// packet size

// data 0 start

填写结构体中对应的总文件大小（最大支持1MB
文件），本包相对于起始文件的偏移量，本包
的大小（所有包大小相加应等于文件大小），数据，然后发送即可。

所有文件数据发送完成后，需特别再发一次偏移量和包大小都为0
的数据，作为此文件发送结 束的标志。

> 举例：
>
> 发送一个150KB 的文件到模组，单次发送80KB，发送过程如下：
>
> 第一包：
>
> www.hzgrow.com

file_data(0, 150\*1024, 0, 80\*1024, data);

> 42
>
> <img src="./a10sveb3.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册
>
> 第二包：
>
> 表明数据传输完成的终止包：
>
> file_data (0, 150\*1024, 80\*1024, 70\*1024, data);

file_data (0, 150\*1024, 0, 0, data)

特征文件传输完成后，使用ID_ENROLL_WITH_FEATURE
命令进行注册。特征注册时模组固
件会解析特征文件，并以特征文件中包含的信息进行注册。为使各个注册方法的协议保持一致，所
以特征注册协议的参数中也包含了user_name, face_direction
等信息。但因为特征文件中已经包含
了一个用户的所有信息，所以这些参数在模组的固件中没有进行任何处理，其作用仅为填充。

**19.25** **ID_TRANS_FILE_PACKET** **&** **ID_ENROLL_FROM_IMAGE**

> 用图片注册的第一步需要先下发人脸图片文件，接受文件数据的结构体如下：
>
> typedef struct {
>
> uint8_t store_tyep;
>
> uint8_t feat_size\[4\];
>
> uint8_t offset\[4\];
>
> uint8_t psize\[2\];
>
> uint8_t data\[0\];
>
> } s_msg_trans_file_data;

// must be 0, store in memory

// transfer file size, int -\> \[s1 s2 s3 s4\]

// transfer file offset

// packet size

// data 0 start

填写结构体中对应的总文件大小（最大支持1MB
文件），本包相对于起始文件的偏移量，本包
的大小（所有包大小相加应等于文件大小），数据，然后发送即可。

所有文件数据发送完成后，需特别再发一次偏移量和包大小都为0
的数据，作为此文件发送结 束的标志。

> 举例：
>
> 发送一个150KB 的文件到模组，单次发送80KB，发送过程如下：
>
> 第一包：
>
> 第二包：
>
> 表明数据传输完成的终止包：
>
> file_data(0, 150\*1024, 0, 80\*1024, data);
>
> file_data (0, 150\*1024, 80\*1024, 70\*1024, data);

file_data (0, 150\*1024, 0, 0, data)

图片文件传输完成后，使用ID_ENROLL_FROM_IMAGE
命令进行注册。图片注册附带的消息 data 如下:

> typedef struct {
>
> uint8_t admin; // the user will be set to admin
>
> uint8_t user_name\[USER_NAME_SIZE\];
>
> uint8_t img_type;
>
> uint8_t timeout;

// 0 for RGB, 1 for IR, other is invalid

> // timeout, unit second default 10s
>
> } s_msg_enroll_from_img_data;
>
> www.hzgrow.com 43
>
> <img src="./t0pgf3pu.png"
> style="width:1.03833in;height:0.27833in" />F900 使用手册

\[admin\]指明该录入的人为管理员；\[timeout\]为录入过程中的超时时间（单位s），默认为
10s， 可以在发送录入命令时设置，超时时间用户可以随意设置，最大不超过
255s；\[img_type\]表示图片 的类型，0 为RGB 图片，1 为IR
图片，其他值非法。

> www.hzgrow.com 44
