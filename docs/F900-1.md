![](_page_0_Picture_0.jpeg)

# **F900 人脸识别模块 用户手册**

![](_page_0_Picture_2.jpeg)

杭州城章科技有限公司 2023 年 3 月 Ver 1.0

![](_page_1_Picture_1.jpeg)

# 版本修订

| 版本号  | 修改日期   | 修改内容 | 修改人  |
|------|--------|------|------|
| V1.0 | 2023.3 | 创建   | 城章科技 |
|      |        |      |      |

![](_page_2_Picture_1.jpeg)

### 目录

| 1 | 1 概述               | 1  |
|---|--------------------|----|
| 2 | 2 产品介绍             | 2  |
|   | 2.1 产品规格           | 2  |
| 2 | 2、 工作条件            | 3  |
|   | 2.2 模组框图           | 4  |
|   | 2.3 模组正反面示意图       | 4  |
|   | 2.4 产品组成           | 4  |
|   | 2.5 模组管脚定义         | 5  |
|   | 2.5.1 通讯接口         | 5  |
|   | 2.5.2 管脚布局图        |    |
|   | 2.5.3 模组管脚定义       | 5  |
|   | 2.6 模组结构图          | 6  |
|   | 2.6.1 双目摄像头板和核心计算板 | 6  |
| 3 | 3 功能描述             | 7  |
|   | 3.1 工作模式           | 7  |
|   | 3.2 电源设计           | 7  |
|   | (1) 引脚介绍           | 7  |
|   | (2) 减少电压跌落         | 7  |
|   | 3.3 开关机            |    |
|   | (1) 开机             |    |
|   | (2) 关机             |    |
| 4 | 4 安装               |    |
|   | (1) 丝印与油墨设计:       | 9  |
|   | (2) 模组镜头安装角度:      |    |
| 5 | 5 注意事项             | 10 |
| 6 | 6 通讯接口             | 11 |
| 7 | 7 指令格式详解           | 11 |
|   | 7.1 指令基本格式         | 11 |
| 8 | 8 通信消息详解           | 12 |
|   | 8.1 通信消息类型         | 12 |
| 9 | 9 指令详解             | 14 |
|   | 9.1 消息接收指令(H→M)    | 14 |

![](_page_3_Picture_1.jpeg)

|    | 9.2 消息发送指令(M→H)                         | . 18 |
|----|-----------------------------------------|------|
|    | 9.2.1 REPLY 消息的发送                       | 19   |
|    | 9.2.2 NOTE 消息的发送                        | . 22 |
|    | 9.2.3 IMAGE 消息的发送                       | 25   |
| 10 | 主控接收消息过程                                | . 25 |
| 11 | 一般消息处理过程                                | 26   |
| 12 | 上下电过程                                   | . 27 |
| 13 | 录入过程                                    | 28   |
| 14 | 录入说明                                    | 29   |
| 15 | 解锁过程                                    | 30   |
| 16 | 防劫持功能说明                                 | 30   |
| 17 | 加密通信过程                                  | 30   |
| 18 | OTA 升级过程                                | 32   |
| 7、 | 模块反馈 OK;                                | . 32 |
| 19 | 补充说明                                    | . 33 |
|    | 19.1 ID_REPLY                           | 33   |
|    | 19.2 ID_NOTE                            | . 34 |
|    | 19.3 ID_RESET                           | . 35 |
|    | 19.4 ID_GETSTATUS                       | 35   |
|    | 19.5 ID_VERIFY                          | . 35 |
|    | 19.6 ID_ENROLL                          | 36   |
|    | 19.7 ID_DELUSER                         | 37   |
|    | 19.8 ID_DELALL                          | 37   |
|    | 19.9 ID_GETUSERINFO                     | 37   |
|    | 19.10 ID_FACERESET                      | . 38 |
|    | 19.11 ID_POWERDOWN                      | . 38 |
|    | 19.12 ID_DEMOMODE                       | . 38 |
|    | 19.13 ID_SNAPIMAGE                      | . 38 |
|    | 19.14 ID_GETSAVDIMAGE & ID_UPLOADIMAGE  | 38   |
|    | 19.15 ID_CAPTURE & ID_UPLOADIMAGE       | 39   |
|    | 19.16 ID_CAPTURE_PIC_TYPE               | 39   |
|    | 19.17 ID_GET_ALL_USERID                 | . 39 |
|    | 19.18 ID_GET_LOGFILE &ID_UPLOAD_LOGFILE | . 40 |
|    | 19.19 ID SET RELEASE ENC KEY            | .40  |

![](_page_4_Picture_0.jpeg)

![](_page_4_Picture_1.jpeg)

| 19.20<br>ID_INIT_ENCRYPTION                                  | 40 |
|--------------------------------------------------------------|----|
| 19.21<br>ID_SET_THRESHOLD_LEVEL<br>41                        |    |
| 19.22<br>ID_ENROLL_ITG                                       | 41 |
| 19.23<br>ID_GET_FEATURE_INFO<br>&<br>ID_UPLOAD_FEATURE42     |    |
| 19.24<br>ID_TRANS_FILE_PACKET<br>&<br>ID_ENROLL_WITH_FEATURE | 42 |
| 19.25<br>ID_TRANS_FILE_PACKET<br>&<br>ID_ENROLL_FROM_IMAGE43 |    |

![](_page_5_Picture_1.jpeg)

# <span id="page-5-0"></span>**1** 概述

F900 人脸识别模组,具有功耗低、成本低、快速识别、外观靓丽、产品结构小巧精致等特点, 采用了高算力 Giraffe AI Chip 芯片,使用自研最优人脸识别算法,算法性能优良,保证用户最佳体 验效果,可快速完成深度计算和人脸识别计算的完整过程,直接输出人脸识别结果。

本产品能快速准确获取目标的深度信息,针对不同区域,建立高频人脸库,减少用户二次确认 概率,有效提升识别效率。算法具备自学习能力,人脸识别会随使用次数不断提高,识别通过率高 达 99.9%,认假率低于百万分之一,强光、暗光、逆光皆好用。

本产品芯片硬件底层搭载加密技术,防止照片、面具、视频等攻击作假,确保数据安全可靠。

本产品可广泛应用于智能门锁、门禁系统、终端刷脸设备等相关领域,能满足办公室、园区、 公寓等场所的 3D 双目人脸识别能门锁、门禁系统、终端刷脸设备等应用需求。

![](_page_6_Picture_1.jpeg)

# <span id="page-6-0"></span>2 产品介绍

# <span id="page-6-1"></span>2.1 产品规格

(1) F900 主要产品规格如下表 2-1 所示。

表 2-1 F900 主要产品规格

| 参数          | 性能                                          |
|-------------|---------------------------------------------|
| 物理特征        | 39.0mm * 14.5mm * 9.4mm                     |
| 通讯接口        | UART                                        |
| 电源          | 5~12V                                       |
| 光学          | FOV D90°, H62°, V77°                        |
| 摄像头         | 双 IR 深度摄像头模组                                |
| 存储容量        | 50 个人                                       |
| 是否存在自学习     | 是                                           |
| 识别距离        | 0.4~1米(最佳识别距离约 0.6米)                        |
| 冷启动识别速度     | < 1.4 秒                                     |
| 是否存在自学习     | 是                                           |
| 认假率(FAR)    | <0.0001%                                    |
| 通讯波特率(UART) | 115200bps (默认)                              |
| 外部供电电压      | 4.5 ~ 13.5(V)                               |
| 工作温度        | -20° C ~ +70° C                             |
| 存储温度        | -40° C ~ +90° C                             |
| 工作湿度        | <95%                                        |
| 存储湿度        | <95%                                        |
| 峰值功耗        | <2.3W                                       |
| 基线          | 18 mm                                       |
| ESD         | 人体模型符合 ANSI / ESDA / JEDEC JS-001 规范 ±2000V |
| L3D         | 充电设备模型符合 JEDEC 规范 JESD22-C101 ±500V         |

![](_page_7_Picture_1.jpeg)

⑵软件参数如下表 2-2 所示。

#### 表 2-2 F900 软件参数表

| 符号   | 特性      | 最小                            |
|------|---------|-------------------------------|
|      | 非活体攻击告警 | 支持                            |
|      | 多人注册    | 支持(最大人脸)                      |
|      | 多人识别    | 支持(优先最大人脸)                    |
| 应用功能 | 活体等级设置  | 支持                            |
|      | 注册方式    | 抓拍注册                          |
|      | OTA     | 支持                            |
|      | 库容量     | 个人<br>50                      |
|      | 识别方式    | 最大脸单人识别                       |
|      | 活体识别    | 各种材质的图片,视频,硅胶头套等均可有效拦截        |
| 人脸参数 | 活体检测    | TAR:98%<br>@<br>FAR:0.001%    |
|      | 人脸比对    | TAR:98%<br>@<br>FAR:0.0001%   |
|      | 冷启动识别速度 | 秒<br><<br>1.4                 |
|      | 识别距离    | 米(最佳效果约<br>米)<br>0.4-1<br>0.6 |

#### <span id="page-7-0"></span>⑶ 工作条件

外部供电电压和存储温度的绝对最大额定值如下表 2-3 所示。

| 符号   | 特性   |      | 极限值   |
|------|------|------|-------|
|      |      | 最小   | 最大    |
| VCC  | 外部供电 | 4.5V | 13.5V |
| Tstg | 存储温度 | -55℃ | +150℃ |

表 2-3 绝对最大额定值

推荐外部供电电压工作条件为 5~12V,最小极限值为 4.5V,最大极限值为 13.5V。

![](_page_8_Picture_1.jpeg)

# <span id="page-8-0"></span>**2.2** 模组框图

正反面示意图如下图 2-1 所示。

![](_page_8_Figure_4.jpeg)

# <span id="page-8-1"></span>**2.3** 模组正反面示意图

正反面示意图如下图 2-2 所示。

![](_page_8_Picture_7.jpeg)

图 2-2 正反面示意图

# <span id="page-8-2"></span>**2.4** 产品组成

模组由双目摄像头模组和 Giraffe AI Chip 核心计算板组成。具体描述如下表 2-4 所示。

|         | 名称        | 描述                                      |
|---------|-----------|-----------------------------------------|
|         | 处理器       | 芯片<br>Giraffe<br>AI<br>Chip             |
| 核心计算板   | 对外接口支持    | UART(通讯、OTA)                            |
|         | 电源接口      | 路<br>12V,1.2A<br>直流宽电压输入<br>1<br>5<br>~ |
|         | 摄像头<br>IR | 深度图像分辨率:720*1280,480*640<br>等           |
| 双目摄像头模组 | 光源        | LED,850nm                               |
|         | PCB       | 支架                                      |

表 2-4 模组具体描述

![](_page_9_Picture_1.jpeg)

# <span id="page-9-0"></span>**2.5** 模组管脚定义

#### <span id="page-9-1"></span>2.5.1 通讯接口

默认波特率 115200bps,不使用硬件/软件流控制,8 位数据位,1 位停止位,不使用奇偶校验 位。

### <span id="page-9-2"></span>2.5.2 管脚布局图

F900 共有 4 个管脚,管脚布局图如下图 2-3 所示。

![](_page_9_Figure_7.jpeg)

图 2-3 F900 管脚布局图

### <span id="page-9-3"></span>2.5.3 模组管脚定义

⑴模组管脚定义表如下表 2-5 所示。

表 2-5 F900 管脚定义表

| 序号 | 名称  | 功能描述     |
|----|-----|----------|
| 1  | GND | 地信号      |
| 2  | RX  | 模组串口接收引脚 |
| 3  | TX  | 模组串口发送引脚 |
| 4  | VCC | 模组电源输入   |

![](_page_10_Picture_1.jpeg)

⑵串口逻辑电平如下表 2-6 所示。

表 2-6 串口逻辑电平

| 参数  | 最小值  | 最大值 | 单位 |
|-----|------|-----|----|
| VIL | -0.3 | 0.4 | V  |
| VIH | 2.4  | 3.6 | V  |

<span id="page-10-0"></span>注:通过 4 线串口,给本模组提供电源的时候,需要使用可以控制开启与关闭的外部电源。

# **2.6** 模组结构图

### 2.6.1 双目摄像头板和核心计算板

<span id="page-10-1"></span>⑴ F900 整个模组尺寸为 39.0mm x 14.5mm x 9.4mm。模组尺寸图如下图 2-4 所示。

![](_page_10_Figure_9.jpeg)

图 2-4 F900 尺寸图

⑵ F900 爆炸图如下图 2-5 所示。

![](_page_10_Picture_12.jpeg)

图 2-5 F900 爆炸图

![](_page_11_Picture_1.jpeg)

# <span id="page-11-0"></span>**3** 功能描述

# <span id="page-11-1"></span>**3.1** 工作模式

F900 模组有两种工作模式:

- 正常工作模式:Idle 软件正常运行。
- <span id="page-11-2"></span>关机模式:在此模式下,PMIC 停止给模块的电源供电。

# **3.2** 电源设计

<span id="page-11-3"></span>⑴ 引脚介绍

F900 模组有 VCC 引脚用于连接外部的 UART 串口供电。

<span id="page-11-4"></span>⑵ 减少电压跌落

模组的供电范围为 5V~12V,需要确保输入电压不低于 4.5V。

![](_page_11_Figure_12.jpeg)

为了减少电压跌落,需要使用低 ESR(ESR=0.7Ω,25V 以上耐压)的 100μF 滤波电容。同 时建议分别给VIN 预留3 个具有最佳ESR 性能的片式多层陶瓷电容(MLCC,25V以上耐压)10uF、 100nF、100pF,且电容靠近 VIN 引脚放置。外部供电电源连接模块时, VIN 需要采用星型走线。 VIN 走线宽度应不小于 1mm。原则上,VIN 走线越长,线宽越宽。

另外,为了保证电源稳定,建议在电源前端加 VRWM=12V,PPP=2550W 的 TVS 管。

![](_page_11_Picture_15.jpeg)

www.hzgrow.com 7

![](_page_12_Picture_1.jpeg)

并建议增加一个过流保护电路,参考原理框图如下图 3-3 所示:

![](_page_12_Picture_3.jpeg)

图 3-3 过流保护电路参考原理图

# <span id="page-12-0"></span>**3.3** 开关机

F900 模组采用直接上电下电模式。

#### <span id="page-12-1"></span>⑴ 开机

- 开机时候,主控端输出开机信号给电源开关,打开电源开关给模组上电。
- 开机时序如下图 3-4 所示:

![](_page_12_Figure_10.jpeg)

#### 说明:

- A:人脸模块上电
- B:人脸模块发送 ready 信号给锁控
- C:锁控向人脸模组发出 verify 指令
- D:锁控收到人脸模组 verify 结果

#### Ta: 520ms

Tb: 典型测试场景 50CM 测得数据 700ms。该数据与测试距离和测试人脸配合有关, 最大不超过 1100ms。

图 3-4 开机时序图

#### <span id="page-12-2"></span>⑵ 关机

模块可通过发送控制命令关机的方式正常关机。

![](_page_13_Picture_1.jpeg)

# <span id="page-13-0"></span>**4** 安装

在固定 F900 的摄像头模组时,使用机械结构压片来固定,保证在震动时不松动;摄像头和主 板使用锁螺丝固定,并避免摄像头模组变形,影响识别效果和精度。模组摄像头部分安装的高度和 安装角度,直接影响人脸解锁支持的身高。

- <span id="page-13-1"></span>⑴ 丝印与油墨设计:
  - 开窗建议比镜头 FOV 大 7 度左右;
  - 开窗处如果需要涂敷油墨,需要保证油墨在 850nm 波段透过率大于 90%,建议喷涂 增透膜提高透光率,并且保持喷面的平整度和洁净度。
- <span id="page-13-2"></span>⑵ 模组镜头安装角度:

摄像头模组安装时主光轴与水平夹角约为 21°,摄像头的视场角度侧视图下图 4-1 所示。

![](_page_13_Figure_9.jpeg)

图 4-1 摄像头视场角度侧视图

![](_page_14_Picture_1.jpeg)

# <span id="page-14-0"></span>**5** 注意事项

- 本产品属于精密装置,避免碰撞、跌落、震动,以免主板器件脱落或镜头内部损坏,导致出现 功能或性能问题。
- 装有本产品的设备避免在阳光下使用,推荐在室内或无太阳光的地方使用。
- 本产品运输过程中采用气泡袋或者珍珠棉包裹保护,且需要避免手、灰尘、水渍等接触。
- 如果摄像头部分需覆盖玻璃盖板,要求玻璃的全光谱通光率大于 95%以上。

![](_page_15_Picture_1.jpeg)

# <span id="page-15-0"></span>**6** 通讯接口

模组和主控之间采用串口方式通信。默认波特率为 115200bps,支持常见的波特率。不使用硬 件/软件流控。8 位数据位和 1 位停止位,无奇偶校验位。

# <span id="page-15-1"></span>**7** 指令格式详解

# <span id="page-15-2"></span>**7.1** 指令基本格式

主控与模块通信的基本消息格式如下表 2-1 所示。

表 2-1 指令基本消息格式

| 名称  | 包头         | 消息<br>ID  | 数据长度       | 消息数据       | 校验码       |
|-----|------------|-----------|------------|------------|-----------|
| 字节数 | 2<br>bytes | 1<br>byte | 2<br>bytes | N<br>bytes | 1<br>byte |
| 内容  | 0xEFAA     | xxH       | xxxxH      | data       | XOR_VALUE |

- 包头是固定的消息开头同步字 0xEFAA。
- 消息 ID 是各种类型的消息 ID。
- 数据长度是消息数据的长度。
- 消息数据是消息对应的 data,长度为 N bytes,0<=N<65535,当 N=0 时表示此消息无数 据部分。
- 校验码是从消息 ID 到校验码之间所有字节按位做 XOR 运算(包括消息 ID 的字节)。
- 对于多字节的高字节在前低字节在后(如 2 bytes 的 00 06 表示 0006,而不是 0600)。

![](_page_16_Picture_1.jpeg)

# <span id="page-16-0"></span>8 通信消息详解

# <span id="page-16-1"></span>8.1 通信消息类型

模块(M)和主控(H)的所有通信消息类型都包含消息 ID 和消息 data,通讯消息类型如下表 3-1 所示。

表 3-1 通信消息类型

| 消息 ID                 | Code | 方向  | 消息数据的结构                        | TO (ms) | 备注                                             |
|-----------------------|------|-----|--------------------------------|---------|------------------------------------------------|
| ID_REPLY              | 0x00 | M→H | s_msg_reply_data               | N/A     | Reply 是模块对主控命令的应答,模块对<br>主控的每条命令都会应答,详解见 4.2.1 |
| ID_NOTE               | 0x01 | M→H | s_msg_note_data                | N/A     | Note 是模块主动发给主控的信息,详解见<br>4.2.2                 |
| ID_IMAGE              | 0x02 | M→H | image                          | N/A     | 模块给主控传送图片、文件                                   |
| ID_RESET              | 0x10 | H→M | N/A                            | 1000    | 停止所有在处理的消息,模块进入<br>standby 状态                  |
| ID_GETSTATUS          | 0x11 | H→M | N/A                            | 200     | 立刻返回模块当前状态                                     |
| ID_VERIFY             | 0x12 | H→M | s_msg_verify_data              | 10000   | 鉴权解锁                                           |
| ID_ENROLL             | 0x13 | H→M | s_msg_enroll_data              | 10000   | 交互式录入用户                                        |
| ID_CAPTURE            | 0x14 | H→M | N/A                            | N/A     | 获取最近录入或者识别时候抓拍的图片大小                            |
| ID_SNAPIMAGE          | 0x16 | H→M | s_msg_snap_image_d<br>ata      | N/A     | 抓拍图片并存储到本地                                     |
| ID_GETSAVEDIMA<br>GE  | 0x17 | H→M | s_msg_get_saved_im<br>age_data | 500     | 获取待上传图片大小                                      |
| ID_UOLOADIMAGE        | 0x18 | H→M | s_msg_upload_image<br>_data    | 10000   | 将本地存储的图片上传到主控                                  |
| ID_DELUSER            | 0x20 | H→M | s_msg_deluser_data             | 200     | 删除单个注册用户                                       |
| ID_DELALL             | 0x21 | H→M | N/A                            | 200     | 删除所有注册用户                                       |
| ID_GETUSERINFO        | 0x22 | H→M | s_msg_getuserinfo_dt<br>at     | 200     | 获得某个注册用户信息                                     |
| ID_FACERESET          | 0x23 | H→M | N/A                            | 200     | 重置算法状态,如正在精选交互式录入,<br>会清空已录入的方向                |
| ID_GET_ALL_USE<br>RID | 0x24 | H→M | N/A                            | 500     | 获取所有已注册用户的数量和 ID                               |
| ID_ENROLL_ITG         | 0x26 | H→M | s_msg_enroll_itg               | 10000   | 集成支持并扩展所有录入方式                                  |
| ID_GET_VERSION        | 0x30 | H→M | N/A                            | 10000   | 获得软件版本信息                                       |
| ID_GET_SN             | 0x35 | H→M | N/A                            | 1000    | 获得模组设备 SN                                      |
| ID_START_OTA          | 0x40 | H→M | s_msg_startota_data            | N/A     | 进入 OTA 升级模式                                    |

![](_page_17_Picture_1.jpeg)

| ID_STOP_OTA                | 0x41 | H→M | N/A                            | N/A  | 退出 OTA 模式,模组重启                   |
|----------------------------|------|-----|--------------------------------|------|----------------------------------|
| ID_GET_OTA_STAT US         | 0x42 | H→M | N/A                            | N/A  | 获取 OTA 状态以及传输升级包的起始包序号           |
| ID_OTA_HEADER              | 0x43 | H→M | s_msg_otaheader_dat<br>a       | N/A  | 发送升级包的大小、总包数、分包大小、<br>升级包的 md5 值 |
| ID_OTA_PACKET              | 0x44 | H→M | s_msg_otapacket_dat<br>a       | N/A  | 发送升级包,包括包序号、包大小、包数据              |
| ID_INIT_ENCRYPTI<br>ON     | 0x50 | H→M | s_msg_init_encryption<br>_data | 1000 | 设置加密随机数                          |
| ID_CONFIG_BAUD<br>RATE     | 0x51 | H→M | s_msg_config_baudra<br>te      | 100  | OTA 模式下设定通信口波特率                  |
| ID_SET_RELEASE<br>_ENC_KEY | 0x52 | H→M | s_msg_enc_key_num<br>ber_data  | N/A  | 设定量产加密秘钥序列,掉电会保存                 |
| ID_SET_DEBUG_E NC_KEY      | 0x53 | H→M | s_msg_enc_key_num<br>ber_data  | N/A  | 设定调试加密秘钥序列,掉电丢失                  |
| ID_GET_LOGFILE             | 0x60 | H→M | 1 byte                         | 1000 | 保持 log 到内存中                      |
| ID_UPLOAD_LOGF<br>ILE      | 0x61 | H→M | s_msg_upload_logfile<br>_data  | N/A  | 将保持的 log 上传到主控                   |
| ID_SET_THRESHO LD_LEVEL    | 0xD4 | H→M | s_msg_algo_threshold<br>_level | N/A  | 设置算法安全等级                         |
| ID_POWERDOWN               | 0xED | H→M | N/A                            | 1000 | 模块准备关机,结束当前在处理的任务,<br>清除文件系统缓存   |
| ID_DEMOMODE                | 0xFE | H→M | N/A                            | 100  | 进入演示模式                           |
| ID_TRANS_FILE_P<br>ACKET   | 0x90 | H→M | s_msg_trans_file_data          | N/A  | 向模块发送文件数据                        |
| ID_ENROLL_FROM<br>_IMAGE   | 0x91 | H→M | s_msg_enroll_from_i<br>mg_data | 1000 | 通过图片注册用户                         |
| ID_GET_FEATURE<br>_INFO    | 0x92 | H→M | s_msg_get_face_feat<br>ure     | N/A  | 获取用户特征信息                         |
| ID_UPLOAD_FEAT<br>URE      | 0x93 | H→M | 同 ID_ENROLL                    | N/A  | 上传特征数据                           |
| ID_ENROLL_WITH _FEATURE    | 0x94 | H→M | s_msg_enroll_data              | N/A  | 通过特征注册用户                         |
| ID_CAPTURE_PIC_<br>TYPE    | 0x9A | H→M | s_msg_capture_pic_ty pe        | N/A  | 设置抓拍图片类型                         |
| ID_MX_GET_ALL_<br>USERID   | 0x9B | H→M | N/A                            | 500  | 获取所有已注册用户的数量和 ID                 |
| ID_ENROLL_SINGL<br>E       | 0x1D | H→M | 同 ID_ENROLL                    | N/A  | 通过单张人脸注册用户                       |

大多数消息处理都对应有 timeout 超时时间定义, timeout 指的是主控等待模块处理的最长时间,即模块处理主控命令的最长时间。当指令处理超时,主控可采用如下几种处理方式:

![](_page_18_Picture_1.jpeg)

- 发送 ID\_GETSTATUS 指令:此消息能快速获取模块的工作状态,若死机则无返回,主控 可直接断电。
- 发送 RESET 指令:停止所有当前的处理,模块进入 standby 的状态,等待主控新的指 令。
- 认为模块死机:主控可采用断电重启的处理方式。

# <span id="page-18-0"></span>**9** 指令详解

# <span id="page-18-1"></span>**9.1** 消息接收指令**(H**→**M)**

- 功能说明:主控应该按照模块消息接收的完整协议格式向模块发送命令。
- 指令包格式:

表 4-1 模块消息接收的完整协议格式

| 包头         | 消息<br>ID  | 数据长度       | 消息数据       | 校验码       |
|------------|-----------|------------|------------|-----------|
| 2<br>bytes | 1<br>byte | 2<br>bytes | N<br>bytes | 1<br>byte |
| 0xEFAA     | xxH       | xxxxH      | data       | XOR_VALUE |

#### 辅助说明:

- 数据长度是消息数据的长度。
- 消息 ID 命令内容和 data 的定义如下表 4-2 所示。

表 4-2 消息 ID 命令和 data 的定义

| 命令(*表示携带      |      |                   | data                        |                     |
|---------------|------|-------------------|-----------------------------|---------------------|
| data)         | Code | 结构体               | 内容                          | 备注                  |
| RESET         | 0x10 |                   | 无                           |                     |
| GET<br>STATUS | 0x11 | 无                 |                             | 无                   |
|               |      |                   |                             | 解锁成功后是否立刻断电         |
|               |      | s_msg_verify_data | pd_rightaway<br>(1<br>byte) | 1:Yes               |
| VERIFY*       | 0x12 |                   |                             | 0:No                |
|               |      |                   | timeout<br>(1<br>byte)      | 解锁超时时间<br>(单位<br>s) |
|               |      |                   |                             | 是否设置为管理员            |
| ENROLL*       | 0x13 | s_msg_enroll_data | admin<br>(1<br>byte)        | 1:Yes               |
|               |      |                   |                             | 0:No                |

![](_page_19_Picture_1.jpeg)

|                  |         |                                | user_name (32 bytes)                 | 录入用户姓名                             |  |
|------------------|---------|--------------------------------|--------------------------------------|------------------------------------|--|
|                  |         |                                | s_face_dir (1byte)                   | 用户需要录入的方向,具体<br>参数如表 <b>4-3</b> 所示 |  |
|                  |         |                                | timeout (1 byte)                     | 录入超时时间 (单位 s)                      |  |
| CAPTURE          | 0x14    |                                | 无                                    | 获取最近录入或者识别时候<br>抓拍的图片大小            |  |
|                  |         |                                | image_counts (1byte)                 | 抓拍图片的数量                            |  |
| SNAP IMAGE*      | 0x16    | s_msg_snap_image_dat<br>a      | start_number (1 byte)                | 抓拍图片的起始 编号<br>(1-30)               |  |
| GET SAVED IMAGE* | 0x17    | s_msg_get_saved_imag<br>e_data | image_number (1 byte)                | 待传输图片的编号                           |  |
| UPLOAD IMAGE*    | 0x18    | s_msg_upload_image_d           | upload_image_offset [4] (4<br>bytes) | 待上传图片的偏移量                          |  |
| OFLOAD IMAGE     | 0.00    | ata                            | upload_image_size [4] (4<br>bytes)   | 此次上传图片的大小,最大<br>4K                 |  |
| DELETE LICED*    | 0,420   | a many daliyaan data           | user_id_heb (1 byte)                 | 生则及日 <b>克药 ID</b>                  |  |
| DELETE USER*     | E USER* |                                | user_id_leb (1 byte)                 | 待删除用户的 ID                          |  |
| DELETE ALL       | 0x21    | 无                              |                                      | 删除所有用户的 ID                         |  |
| GET USER INFO*   | 0x22    | s_msg_getuserinfo_data         | user_id_heb (1 byte)                 | 一<br>已注册用户的 <b>ID</b>              |  |
| OLT GOLIVING     | UNZZ    | 3_m3g_getu3enmo_uutu           | user_id_leb (1 byte)                 |                                    |  |
| FACE RESET       | 0x23    |                                | 无                                    | 清除录入状态                             |  |
| GET ALL USERID   | 0x24    |                                | 无                                    | 获取所有已注册用户的数量<br>和 ID               |  |
|                  |         |                                |                                      | 是否设置为管理                            |  |
|                  |         |                                | admin (1 byte)                       | 1: Yes                             |  |
|                  |         |                                |                                      | 0: No                              |  |
|                  |         |                                | user_name (32 bytes)                 | 录入用户姓名                             |  |
| ENROLL ITG       | 0x26    | s_msg_enroll_itg               | face_direction (1 byte)              | 用户需要录入的方向,具体<br>参数如表 <b>4-3</b> 所示 |  |
|                  |         |                                |                                      | 录入方式                               |  |
|                  |         |                                | enroll_type(1 byte)                  | 1: 单张录入                            |  |
|                  |         |                                |                                      | 0: 交互式录入                           |  |
|                  |         |                                | onable distinct (4 but )             | 是否允许用户重复录                          |  |
|                  |         |                                | enable_duplicate(1 byte)             | 1: 允许重复录入                          |  |

![](_page_20_Picture_1.jpeg)

|                        |                                   |                               |                      | 0: 不允许重复录入                                           |
|------------------------|-----------------------------------|-------------------------------|----------------------|------------------------------------------------------|
|                        |                                   | timeout (1 byte)              |                      | 录入超时时间 (单位 s)                                        |
|                        |                                   |                               | resv(3 bytes)        | 暂不支持                                                 |
| GET VERSION            | 0x30                              | :                             | 无                    | 获取软件版本                                               |
| GET SN                 | 0x35                              |                               | 无                    | 获取 sn 号                                              |
|                        |                                   |                               | v_primary (1 byte)   |                                                      |
| START OTA*             | 0x40                              | s_msg_startota_data           | v_secondary (1 byte) | 固件版本号                                                |
|                        |                                   |                               | v_revision (1 byte)  |                                                      |
| STOP OTA               | 0x41                              |                               | 无                    | OTA 停止                                               |
| GET OTA<br>STATUS      | 0x42                              |                               | 无                    | 获取 OTA 当前状态                                          |
|                        | OTA HEADER* 0x43 s_msg_otaheader_ |                               | fsize_b (4 bytes)    | 固件大小,高字节在前<br>b0b1b2b3H                              |
| OTA HEADER*            |                                   | s_msg_otaheader_data          | num_pkt (4 bytes)    | 总包数,高字节在前<br>b0b1b2b3H                               |
|                        |                                   |                               | pkt_size (2 bytes)   | 每包大小,高字节在前<br>b0b1H                                  |
|                        |                                   |                               | md5_sum (32 bytes)   | 固件 MD5 值                                             |
|                        |                                   |                               | pid (2 bytes)        | 分包序号                                                 |
| OTA PACKET*            | 0x44                              | s_msg_otapacket_data          | psize (2 bytes)      | 分包大小                                                 |
|                        |                                   |                               | data (n bytes)       | 分包内容                                                 |
|                        |                                   |                               | seed[4] (4 bytes)    | 主控发送一个随机数                                            |
| INIT                   | 0x50                              | s_msg_init_encryption_d       | mode                 | 加密模式                                                 |
| ENCRYPTIO*             | 0,30                              | ata                           | crttime[4]           | 当前时区的秒数(1970 年至<br>今)                                |
| CONFIG<br>BAUDRATE     | 0x51                              | s_msg_config_baudrate         | baudrate_inde x      | 波特率<br>1:115200<br>2:230400<br>3:460800<br>4:1500000 |
| SET RELEASE<br>ENC KEY | 0x52                              | s_msg_enc_key_number<br>_data | enc_key_number[16]   | 加密序列                                                 |
| SET DEBUG ENC<br>KEY   | 0x53                              | s_msg_enc_key_number<br>_data | enc_key_number[16]   | 加密序列                                                 |

![](_page_21_Picture_1.jpeg)

| GET LOG FILE*        | 0x60  | 无                            | log_type (1 byte)                     | KERNEL_LOG=0                                                        |
|----------------------|-------|------------------------------|---------------------------------------|---------------------------------------------------------------------|
| OLT LOGTILL          | 0,00  | )u                           | log_type (1 byte)                     | APP_LOG=1                                                           |
| UPLOAD LOG           |       |                              | upload_logfile_offset[4] (4<br>bytes) | 待上传日志的偏移量                                                           |
| FILE*                | 0x61  | ata                          | upload_logfile_size[4] (4             | 此次上传日志的大小,最大                                                        |
|                      |       |                              | bytes)                                | 4K                                                                  |
| POWER DOWN           | 0xED  | 无                            | 无                                     | 无                                                                   |
| DEMO MODE*           | ٥٠٠٢  | domonos do doto              | anabla(4 buta)                        | 1: enable                                                           |
| DEMO MODE*           | 0xFE  | s_msg_demomode_data          | enable(1 byte)                        | 0: disable                                                          |
|                      |       |                              | store_type                            | 0,目前仅支持存放在内存                                                        |
|                      |       |                              | file_size_b[4]                        | 文件大小                                                                |
| TRANS FILE           | 0x90  | s_msg_trans_file_data        | offset[4]                             | 本包数据偏移值                                                             |
| PACKET*              |       |                              | psize[2]                              | 本包数据大小                                                              |
|                      |       |                              | data                                  | 数据                                                                  |
|                      | 0x91  |                              |                                       | 是否设置为管理员                                                            |
|                      |       | s_msg_enroll_from_img_ idata | admin (1 byte)                        | 1: Yes                                                              |
|                      |       |                              |                                       | 0: No                                                               |
| ENROLL FROM          |       |                              | user_name (32 bytes)                  | 录入用户姓名                                                              |
| IMAGE*               |       |                              |                                       | 1:从IR图片录入                                                           |
|                      |       |                              | img_type (1byte)                      | 0: 从 RGB 图录入                                                        |
|                      |       |                              | timeout (1 byte)                      | 录入超时时间 (单位 s)                                                       |
| GET FEATURE          |       |                              | user_id_heb                           | 用户 ID 高八位                                                           |
| INFO*                | 0x92  | s_msg_get_face_feature       | user_id_leb                           | 用户 ID 低八位                                                           |
| UPLOAD               |       | s_msg_upload_face_feat       | upload_feat_offset[4]                 | 上传数据的偏移值                                                            |
| FEATURE*             | 0x96  | ure                          | upload_feat_size[4]                   | 上传数据的大小                                                             |
| ENROLL WITH FEATURE* | 0x94  | 同 ENROLL                     | 同 ENROLL                              | 同 ENROLL                                                            |
| CAPTURE PIC          | 0×0.4 | e meg conture sie ture       | pic_width[2]                          | 图片宽度,b0b1H,当前仅<br>支持宽高比为 640x480、<br>320x240、160x120 三种分<br>辨率      |
| TYPE                 | 0x9A  | s_msg_capture_pic_type       | pic_height[2]                         | 图片高度,高字节在前<br>b0b1H,当前仅支持宽高比<br>为 640x480、320x240、<br>160x120 三种分辨率 |

![](_page_22_Picture_1.jpeg)

|            |      |                |                | 图片类型         |
|------------|------|----------------|----------------|--------------|
|            |      |                | capture_type   | IR:0x0       |
|            |      |                |                | RGB:0x1      |
|            |      |                |                | 图片压缩比率       |
|            |      |                | 压缩质量 30%:0x6   |              |
|            |      | compress_ratio | 压缩质量 50%:0x8   |              |
|            |      |                |                | 压缩质量 80%:0xb |
|            |      |                | is_cutout_face | 图片是否裁剪出人脸,暂不 |
|            |      |                | is_culout_lace | 支持此功能。       |
| GET MX ALL | 0x9B |                | 无              | 获取所有已注册用户的数量 |
| USERID     | OXOD |                |                | 和 ID         |
| ENROLL     | 0x1D | 同 ENROLL       | 同 ENROLL       | 同 ENROLL     |
| SINGLE*    | עוגט | III ENROLL     | Inj ENROLL     | PJ ENROLL    |

◆ 人脸方向定义如下表 4-3 所示。

表 4-3 人脸方向定义

| 人脸方向定义                  | 参数   | 释义        |
|-------------------------|------|-----------|
| FACE_DIRECTION_UP       | 0x10 | 录入朝上的人脸   |
| FACE_DIRECTION_DOWN     | 0x08 | 录入朝下的人脸   |
| FACE_DIRECTION_LEFT     | 0x04 | 录入朝左的人脸   |
| FACE_DIRECTION_RIGHT    | 0x02 | 录入朝右的人脸   |
| FACE_DIRECTION_MIDDLE   | 0x01 | 录入正向的人脸   |
| FACE_DIRECTION_UNDEFINE | 0x00 | 未定义,默认为正向 |

● 示例:

主控发送给模块的 RESET 消息: EF AA 10 00 00 10,数据长度为 0,不携带消息数据,如下表 4-4 所示。

表 4-4 主控发送给模板 RESET 消息示例

| 包头     | 消息 ID              | 数据长度  | 消息数据 | 校验码 |
|--------|--------------------|-------|------|-----|
| 0xEFAA | 10H<br>(ID_R ESET) | 0000Н | 无    | 10H |

# <span id="page-22-0"></span>9.2 消息发送指令(M→H)

模块主要发送三种类型的消息,分别是 REPLY, NOTE, IMAGE。

![](_page_23_Picture_1.jpeg)

### 9.2.1 **REPLY** 消息的发送

- <span id="page-23-0"></span>● 功能说明:模块向主控发送 REPLY 消息。
- 指令包格式:

表 4-5 模块向主控发送的 REPLY 消息的完整协议格式

|          |        |         | 消息               |        |        |           |
|----------|--------|---------|------------------|--------|--------|-----------|
| 包头 消息 ID |        | 数据长度    | s_msg_reply_data |        | 校验码    |           |
|          |        |         | 参数 1             | 确认码    | 参数 2   |           |
| 2 bytes  | 1 byte | 2 bytes | 1 byte           | 1 byte | n byte | 1 byte    |
| 0xEFAA   | 00H    | xxxxH   | xxH              | xxH    |        | XOR_VALUE |

#### ● 辅助说明:

- ◆ 该消息 ID 定义为 ID\_REPLY ,命令码为 0x00,所对应的消息数据的结构是 s\_msg\_reply\_data。
- ◆ 数据长度只包括消息数据的所有字节数。
- ◆ 参数 1 表示本消息是对主控哪一条消息 ID 命令的响应,例如当参数 1=ID\_ENROLL(0x13)时,表示该消息是模块处理完 enroll 任务后回复的消息。参数 1 定义如下表 4-6 所示。

表 4-6 参数 1 定义

| 6 30                     |      |                              | 参数 2                    |                                                  |
|--------------------------|------|------------------------------|-------------------------|--------------------------------------------------|
| 参数 1<br>(*表示携带参数 2)      | code | 结构体                          | 内容                      | 备注                                               |
| ID_RESET                 | 0x10 |                              | 无                       | 无                                                |
|                          |      |                              |                         | 0: IDLE                                          |
|                          | 044  | s_msg_repy_get               | -4-4 (4h. 4-)           | 1: BUSY                                          |
| ID_GETSTA TUS*           | 0x11 | status_data                  | status (1byte)          | 2: ERROR                                         |
|                          |      |                              |                         | 3: INVALID                                       |
|                          |      | s_msg_reply_ve<br>rify_data  | user_id_heb(1byte)      | 己验证用户的 <b>ID</b>                                 |
| ID_VERIFY*(只有当<br>确认码结果为 | 0x12 |                              | user_id_leb(1byte)      |                                                  |
| MR_SUCCESS 时才            |      |                              | user_name(32 bytes)     | 用户名字                                             |
| 有 user_id)               |      |                              | admin (1byte)           | 是否为管理员                                           |
|                          |      |                              | unlockStatus(1 byte)    | 解锁过程中睁闭眼状态                                       |
| ID_ENROLL*(只有当           |      |                              | user_id_heb (1byte)     |                                                  |
| 确认码结果为<br>MR SUCCESS 时才  | 0x13 | s_msg_reply_en               | user_id_leb (1byte)     | 已注册用户的 ID                                        |
| 有 user_id)               |      | roll_data                    | face_direction(1 byte)  | 各个方向人脸的录入状态                                      |
| ID_CAPTURE               | 0x14 | s_msg_reply_ca<br>pture_data | image_size[4] (4 bytes) | 最近录入或者识别图片的大小<br>(bytes) image_size[0]为最高 8<br>位 |

![](_page_24_Picture_1.jpeg)

| ID ON A DIMA OF            | 0.40 |                                                 | <b>エ</b>                   |                                  |
|----------------------------|------|-------------------------------------------------|----------------------------|----------------------------------|
| ID_SNAPIMAGE               | 0x16 |                                                 | 无                          | 无                                |
| ID_GETSA<br>VEDIMAGE*      | 0x17 | s_msg_reply_ge<br>t_saved_image_<br>data        | image_size[4] (4 bytes)    | 待上传图片大小,image_size[0]<br>为最高 8 位 |
| ID_UPLOADIMAGE*            | 0x18 | image_data                                      | 主控要求上传的 size               | 实际图片                             |
| ID_DELUSER                 | 0x20 |                                                 | 无                          | 无                                |
| ID_DELALL                  | 0x21 |                                                 | 无                          | 无                                |
|                            |      |                                                 | user_id_heb(1byte)         | 已注册用户的 <b>ID</b>                 |
| ID_GETUSE RINFO*           | 0x22 | s_msg_reply_ge                                  | user_id_leb(1byte)         |                                  |
| ID_GETUSE KINFO            | UXZZ | tuserinfo_data                                  | user_name (32bytes)        | 己注册用户的姓名                         |
|                            |      |                                                 | admin(1byte)               | 是否为管理员                           |
| ID_FACERESET               | 0x23 |                                                 | 无                          | 无                                |
| ID_GET_ALL_USERI           |      | s_msg_reply_all                                 | user_counts(1bytes)        | 已注册用户数量                          |
| D D                        | 0x24 | _all_userid_data                                | user_id[max_user_count     | 所有已注册用户 ID,使用连续两个字               |
| D                          |      | _an_uscriu_uata                                 | s*2](50*2 bytes)           | 节存储一个 ID, 先存高 8 位                |
| ID_ENROLL_ITG              | 0x26 | 同 ID_ENROLL                                     |                            | 同 ID_ENROLL                      |
| ID_GET_VERSION*            | 0x30 | s_msg_reply_ve<br>rsion_data user_id_leb(1byte) |                            | 版本信息                             |
| ID_GET_SN                  | 0x35 | s_msg_reply_ge<br>t_sn board_sn(33bytes)        |                            | 模组 sn 信息                         |
| ID_START_OTA               | 0x40 | 无                                               |                            | 无                                |
| ID_STOP_OTA                | 0x41 |                                                 | 无                          | 无                                |
|                            |      | s_msg_reply_ge                                  | ota_status(1 byte)         | 4 表示处于 OTA 状态中                   |
| ID_GET_OTA_STAT<br>US      | 0x42 | totastatus_data                                 | next_pid_e(2 bytes)        | 传输固件包的起始序号                       |
| ID_OTA_HEADER              | 0x43 |                                                 | 无                          | 无                                |
| ID_OTA_PACKET              | 0x44 |                                                 | 无                          | 无                                |
| ID_INIT_ENCRYPTI<br>ON     | 0x50 | s_msg_reply_init_<br>encryption_data            | device_id[20]<br>(20bytes) | 设备 id 信息                         |
| ID_CONFIG_BAUDR<br>ATE     | 0x51 | 无                                               |                            | 无                                |
| ID_SET_RELEASE_<br>ENC_KEY | 0x52 | 无                                               |                            | 无                                |
| ID_SET_DEBUG_EN<br>C_K EY  | 0x53 | 无                                               |                            | 无                                |
| ID_GET_LOGFILE*            | 0x60 | s_msg_reply_g<br>et_log_data                    | log_size[4]<br>(4 bytes)   | 待上传 log 的大小                      |
| ID_UPLOAD_LOGFI<br>LE*     | 0x61 | log_data                                        | 主控要求上传的<br>size            | 实际日志信息                           |

![](_page_25_Picture_1.jpeg)

| ID_TRANS_FILE_PA<br>CKET    | 0x90 |                                                                            | 无                              | 无                                 |
|-----------------------------|------|----------------------------------------------------------------------------|--------------------------------|-----------------------------------|
| ID_ENROLL_FROM_<br>IMAGE*   | 0x91 | 同 ID                                                                       | _ENROLL                        | ID_ENROLL                         |
| ID_GET_FEATURE_I<br>NFO*    | 0x92 | s_msg_reply_get<br>_face_feature                                           | feat_size[4]                   | 特征数据的长度信息                         |
| ID_ENROLL_WITH_<br>FEATURE* | 0x94 |                                                                            |                                | 同 ID_ENROLL                       |
| ID_CAPTURE_PIC_T<br>YPE     | 0x9A |                                                                            | 无                              | 无                                 |
|                             |      |                                                                            | user_counts(2bytes)            | 已注册用户数量                           |
| ID_MX_GET_ALL_U<br>SERID    | 0x9B | s_msg_reply_all_<br>all_userid_data user_id[max_user_counts*2](500*2bytes) |                                | 所有己注册用户 ID,使用连续两个字节存储一个 ID,先存高8 位 |
| ID_ENROLL_SINGL<br>E        | 0x1D | 同 ID                                                                       | _ENROLL                        | 同 ID_ENROLL                       |
| ID_SET_THRESHOL D_LEVEL     | 0xD4 |                                                                            | 无                              | 无                                 |
| ID_POWER_DOWN               | 0xED |                                                                            | 无                              | 无                                 |
| ID_DEBUG_MODE               | 0xF0 |                                                                            | 无                              | 无                                 |
| ID_GET_DE<br>BUG_INFO       | 0xF1 | s_msg_reply_get_<br>debug_info_dat a                                       | debug_file_siz[4]<br>(4 bytes) | 待上传数据包的大小                         |
| ID_UPLOAD_DEBU<br>G_INFO    | 0xF2 | s_msg_upload_de upload_debug_info_of bug_info_data fset[4]                 |                                | 数据包的内容                            |
| ID_GETLIBRARY_V<br>ERSION   | 0xF3 | s_msg_reply_libra library_version_info[20 ry_version_data ]                |                                | 版本号信息                             |
| ID_DEMOMODE                 | 0xFE |                                                                            | 无                              | 无                                 |

# ◆ 确认码定义

确认码表示该命令的执行结果,确认码定义如下表 4-7 所示。

表 4-7 确认码定义

| 确认码定义                    | 确认码 | 释义         |
|--------------------------|-----|------------|
| MR_SUCCESS               | 0   | 成功         |
| MR_REJECTED              | 1   | 模块拒绝该命令    |
| MR_ABORTED               | 2   | 录入/解锁算法已终止 |
| MR_FAILED4_CAMERA        | 4   | 相机打开失败     |
| MR_FAILED4_UNKNOWNREASON | 5   | 未知错误       |
| MR_FAILED4_INVALIDPARAM  | 6   | 无效的参数      |
| MR_FAILED4_NOMEMORY      | 7   | 内存不足       |
| MR_FAILED4_UNKNOWNUSER   | 8   | 没有已录入的用户   |

![](_page_26_Picture_1.jpeg)

| MR_FAILED4_MAXUSER       | 9  | 录入超过最大用户数量 |
|--------------------------|----|------------|
| MR_FAILED4_FACEENROLLED  | 10 | 人脸已录入      |
| MR_FAILED4_LIVENESSCHECK | 12 | 活体检测失败     |
| MR_FAILED4_TIMEOUT       | 13 | 录入或解锁超时    |
| MR_FAILED4_AUTHORIZATION | 14 | 加密芯片授权失败   |
| MR_FAILED4_READ_FILE     | 19 | 读文件失败      |
| MR_FAILED4_WRITE_FILE    | 20 | 写文件失败      |
| MR_FAILED4_NO_ENCRYPT    | 21 | 通信协议未加密    |

#### ● 示例:

模块向主控发送的 REPLY 消息: EF AA 00 00 04 13 00 00 01 16,该消息表示模块处理完 enroll 任务回复后给主控的 REPLY 消息,数据长度为 4 个字节,录入成功且录入的用户 ID 是 0x0001,如下表 4-8 所示。

消息数据(N bytes) 包头 消息 ID 数据长度 校验码 s\_msg\_reply\_data 参数 2 参数 1 确认码 13H 00H 00H 01H 0xEFAA 00H 0004H 16H (ID\_ENROLL) (MR\_SUCCESS) (user\_id\_ heb) (user\_id\_leb)

表 4-8 REPLY 消息发送的示例

#### <span id="page-26-0"></span>9.2.2 **NOTE** 消息的发送

- NOTE 消息主要作用是主动向主控返回一些信息,目前 NOTE 消息主要在三种情况下发送:
  - ◆ 开机时模块向主控发送 NID\_READY;
  - ◆ 录入过程中模块向主控发送人脸状态信息;
  - ◆ 解锁过程中模块向主控发送人脸状态信息。
- 功能说明:模块向主控发送 NOTE 消息。
- 指令包格式:

表 4-9 模块向主控发送的 NOTE 消息的完整协议格式

| 包头      |        |         | 消息数据            |         |           |
|---------|--------|---------|-----------------|---------|-----------|
|         | 消息 ID  | 数据长度    | s_msg_note_data |         | 校验码       |
|         |        |         | 参数 1            | 参数 2    |           |
| 2 bytes | 1 byte | 2 bytes | 1 byte          | n bytes | 1 byte    |
| 0xEFAA  | 01H    | xxxxH   | xxH             |         | XOR_VALUE |

- 辅助说明:
  - ◆ 该消息 ID 的定义为 ID\_NOTE,命令码为 0x01,所对应的消息数据的结构是 s\_msg\_note\_data。

![](_page_27_Picture_1.jpeg)

- 数据长度只包括消息数据的所有字节数。
- 参数 1 定义如下表 4-10 所示。

表 4-10 参数 1 定义

| 参数<br>1(*表示携带参数<br>2) | Code | 参数<br>2                      | 说明               |
|-----------------------|------|------------------------------|------------------|
| NID_READY             | 0    | 无                            | 模块已准备好           |
| NID_FACE_STATE*       | 1    | (参数<br>为<br>2<br>2<br>bytes) | 算法执行成功,并且返回人脸信息  |
|                       |      | 主要存储了人脸信息,                   | s_note_data_face |
|                       |      | 详细定义详见表<br>4-11              |                  |
| NID_UNKNOWNERROR      | 2    | 无                            | 未知错误             |
| NID_OTA_DONE*         | 3    | (参数<br>为<br>byte)<br>2<br>1  | 升级完毕<br>OTA      |
|                       |      | 0:OTA<br>sucess;             |                  |
|                       |      | 1:OTA<br>fail                |                  |
| NID_EYE_STATE*        | 4    | (参数<br>为<br>byte)<br>2<br>1  | 解锁过程中睁闭眼状态       |
|                       |      | 12:闭眼模式下检测到睁眼状态;             |                  |
|                       |      | 13:持续一秒均闭眼状态;                |                  |
|                       |      | 14:无法确认的状态。                  |                  |

#### NID\_FACE\_STATE\*所携带的参数 2 的详细定义如下表 4-11 所示。

#### 表 4-11 参数 2 定义

| 结构            | 内容       | 释义                                                 | 类型      |  |
|---------------|----------|----------------------------------------------------|---------|--|
|               |          | 0:FACE_STATE_NORMAL(人脸正常)                          | Int16_t |  |
|               |          | 1:FACE_STATE_NOFACE(未检测到人脸)                        |         |  |
|               |          | 2:FACE_STATE_TOOUP(人脸太靠近图片上边沿,未能录入)                |         |  |
|               |          | 3:FACE_STATE_TOODOWN(人脸太靠近图片下边沿,未能录入)              |         |  |
|               |          | 4:FACE_STATE_TOOLEFT(人脸太靠近图片左边沿,未能录入)              |         |  |
|               |          | 5:FACE_STATE_TOORIGHT(人脸太靠近图片右边沿,未能录入)             |         |  |
|               |          | 6:FACE_STATE_FAR(人脸距离太远,未能录入)                      |         |  |
|               |          | 7:FACE_STATE_CLOSE(人脸距离太近,未能录入)                    |         |  |
|               | State    | 8:FACE_STATE_EYEBROW_OCCLUSION(眉毛遮挡)               |         |  |
|               | (2bytes) | 9:FACE_STATE_EYE_OCCLUSION(眼睛遮挡)                   |         |  |
|               |          | 10:FACE_STATE_FACE_OCCLUSION(脸部遮挡)                 |         |  |
|               |          | 11:FACE_STATE_DIRECTION_ERROR(录入人脸方向错误)            |         |  |
|               |          | 12:FACE_STATE_EYE_CLOSE_STATUS_OPEN_EYE(在闭眼模式检测到   |         |  |
|               |          | 睁眼状态)                                              |         |  |
|               |          | 13:FACE_STATE_EYE_CLOSE_STATUS(闭眼状态)               |         |  |
| s_note_data_f |          | 14:FACE_STATE_EYE_CLOSE_STATUS_UNKOWN_STATUS(在闭眼模式 |         |  |

![](_page_28_Picture_1.jpeg)

| ace |          | 检测中无法判定睁眼状态)                                |         |
|-----|----------|---------------------------------------------|---------|
|     | Left     | 人脸框距离图片最左侧的距离(负数表示人脸框已超出图片最左侧)              | Int16_t |
|     | (2bytes) |                                             |         |
|     | Тор      | 人脸框距离图片最上方的距离(负数表示人脸框已超出图片上方)               | Int16_t |
|     | (2bytes) |                                             |         |
|     | Right    | 人脸框距离图片最右侧的距离(负数表示人脸框已超图片最右侧)               | Int16_t |
|     | (2bytes) |                                             |         |
|     | Bottom   | 人脸框距离图片最下方的距离(负数表示人脸框已超出图片最下方)              | Int16_t |
|     | (2bytes) |                                             |         |
|     | Yaw      | Yaw 为负表示左转头,Yaw 为正表示右转头,旋转方向如图 4-1 所示       | Int16_t |
|     | (2bytes) |                                             |         |
|     | Pitch    | Pitch 为负表示向上抬头,Pitch 为正表示向下低头,旋转方向如图 4-1 所示 | Int16_t |
|     | (2bytes) |                                             |         |
|     | Roll     | Roll 为负表示向右歪头,Roll 为正表示向左歪头,旋转方向如图 4-1 所示   | Int16_t |
|     | (2bytes) |                                             |         |

#### Yaw,Pitch,Roll 旋转方向如下图 4-1 所示。

![](_page_28_Picture_4.jpeg)

图 4-1 Yaw,Pitch,Roll 的旋转方向示意图

#### ● 示例

模块向主控发送的 NOTE 消息: EF AA 01 00 01 00 00。该消息表示这是模块向主控发送的 NOTE 消息,模块已经准备好接收其他命令,数据长度为 1 字节。各个字段对应关系如表 4-12 所示。

|        |       |       | 消息数据(N b           | ytes) |     |
|--------|-------|-------|--------------------|-------|-----|
| 包头     | 消息 ID | 数据长度  | s_msg_note_        | _data | 校验码 |
|        |       |       | 参数 1               | 参数 2  |     |
| 0xEFAA | 01H   | 0001H | 00H<br>(NID_READY) | 无     | 00H |

表 4-12 NOTE 消息发送的示例

![](_page_29_Picture_1.jpeg)

### <span id="page-29-0"></span>9.2.3 **IMAGE** 消息的发送

- 功能说明:模块向主控发送 IMAGE 消息。
- 指令包格式:

表 4-13 模块向主控发送的 IMAGE 消息的完整协议格式

| 包头         | 消息<br>ID   | 数据长度       | 消息数据       | 校验码        |
|------------|------------|------------|------------|------------|
| 2<br>bytes | 1<br>bytes | 2<br>bytes | N<br>bytes | 1<br>bytes |
| 0xEFAA     | 02H        | xxxxH      | image      | XOR_VALUE  |

- 辅助说明:
  - 该消息 ID 的定义为 ID\_IMAGE,命令码为 0x02,所对应的消息数据的结构是 image。
  - 数据长度是消息数据的长度。
  - F900 模块传输图片时,一帧数据最大支持 4000 字节数据的传输。

# <span id="page-29-1"></span>**10** 主控接收消息过程

主控接收模块的消息过程如下图 5-1 所示。

![](_page_29_Figure_13.jpeg)

图 5-1 功能实现示例 1:主控接收消息过程

![](_page_30_Picture_1.jpeg)

# <span id="page-30-0"></span>11 一般消息处理过程

一般消息处理过程如下图 6-1 所示。

![](_page_30_Figure_4.jpeg)

图 6-1 功能实现示例 2: 一般消息处理流程

![](_page_31_Picture_1.jpeg)

# <span id="page-31-0"></span>12 上下电过程

主控主动控制模块的上电和下电,模块上电即进入启动流程, 启动进入 standby 状态,会通知主控 MSG::NOTE::READY, 主控开始发送命令消息,模块处理并返回结果。无消息发送时,主控调用 MSG::POWERDOWN,模块处理并返回结果,主控可断电。流程如下图 7-1 所示。

![](_page_31_Figure_4.jpeg)

图 7-1 功能实现示例 3: 上下电流程

![](_page_32_Picture_1.jpeg)

# <span id="page-32-0"></span>13 录入过程

在录入过程中,人脸模块不限制录入方向的顺序,用户可以任意组合录入方向的顺序。如下图 **8-1** 是以其中一种顺序为例的录入流程,该人脸录入方向的顺序:正向→朝上→朝下。

![](_page_32_Figure_4.jpeg)

图 8-1 功能实现示例 4: 以正向→朝上→朝下为人脸录入顺序的录入流程

当主控下达录入某个方向的人脸的指令后,模块开始工作,并以 NOTE 消息的形式实时返回 人脸的状态、位置、姿态等信息,用户可根据该信息提醒录入人进行姿态位置的调整,当录入成功 后,模块将以 REPLY 消息的形式返回录入结果,如果录入不成功,模块也会相应地返回失败的原因。

注:

- ◆ 当模块拿到的第一帧图片就录入成功时,将直接以 REPLY 消息的形式返回结果。录 入过程中可通过 FACE RESET 指令终止录入,先前的录入状态也会清零。
- ◆ 如果在录入过程中突然断电,之前录入的人脸也不会保存。

![](_page_33_Picture_1.jpeg)

# <span id="page-33-0"></span>**14** 录入说明

人脸录入各个方向的角度说明如下表 9-1 所示。

表 9-1 人脸录入各个方向的角度说明

| 录入方向 | 偏差角度                |  |
|------|---------------------|--|
| 正常   | 正对摄像头,无偏差角度         |  |
| 向上   | 正常向上偏转<br>度<br>5~55 |  |
| 向下   | 正常向下偏转<br>度<br>5~55 |  |
| 向右   | 正常向右偏转<br>度<br>8~60 |  |
| 向左   | 正常向左偏转<br>度<br>8~60 |  |

- 人脸录入各个方向偏转示意图如下所示。
  - 向上和向下偏转如图 9-1 所示。

![](_page_33_Picture_8.jpeg)

图 9-1 向上和向下偏转

向左和向右偏转如图 9-2 所示。

![](_page_33_Picture_11.jpeg)

![](_page_33_Picture_12.jpeg)

图 9-2 向左和向右偏转

- 注:
  - 请不要采用如下图 9-3 所示的转头方式。

![](_page_33_Picture_16.jpeg)

图 9-3 错误转头方式

 在人脸录入的过程中,头部向某个方向转向,并且保持匀速,不要转头角度过大,或 者转头或者速度过快。

![](_page_34_Picture_1.jpeg)

# <span id="page-34-0"></span>15 解锁过程

解锁过程如下图 10-1 所示。

![](_page_34_Figure_4.jpeg)

图 10-1 功能实现示例 5: 解锁流程

# <span id="page-34-1"></span>16 防劫持功能说明

在图 **10-1** 解锁过程中,如果模块检测到闭眼状态,立即返回闭眼状态并且进入睁闭眼检测模式,在接下来的一秒内持续检测:

- 如果在一秒内检测到睁眼状态,则判断为正常解锁;
- 如果在一秒内检测到至少有一帧图像是闭眼状态,则判定为被劫持;
- 如果在一秒内既没有检测到睁眼也没有检测到闭眼的状态,则返回未知状态。

在睁闭眼模式检测都是通过 note 发送消息通知主控人脸状态。

# <span id="page-34-2"></span>17 加密通信过程

加密详细过程请参考《人脸识别锁模组》

- 加密通信过程的步骤如下:
  - 1、主控给模组上电;

![](_page_35_Picture_1.jpeg)

- 2、模组发送 READY(明文)给主控;
- 3、模组第一次开机需要调用 ID\_SET\_RELEASE\_ENC\_KEY 指令设置 16bytes 序列作为 密钥的生成规则;
- 4、主控采用随机数生成随机序列并发送给模组(4bytes)。模组和主控双方根据这随机序 列 ,采用步骤 3 中 16Bytes 规则生成 16bytes 的密码。双方采用相同算法生成相同 的密码。之后双方本次会话都采用此密码加解密;
- 5、F900 模组返回状态并采用随机密码 AES 加密发送产品序列号给主控;
- 6、主控解密,鉴别设备 ID 确认身份后开始处理需求指令,录入或解锁等;
- 7、主控采用随机生成的密码, AES 加密的方式对指令和数据加密并发送给模组;
- 8、模组用第 4 步解密出来的密码解密,判断指令合法性并处理该指令;
- 9、模组用第 4 步解密出来的密码对指令处理结果和数据加密,并发送给主控。
- 加密通信过程的流程如下图 12-1 所示:

![](_page_35_Figure_11.jpeg)

图 12-1 功能实现示例 6:加密通信流程

![](_page_36_Picture_1.jpeg)

# <span id="page-36-0"></span>**OTA** 升级过程

OTA 升级过程步骤如下:

- 、主控发送 ID\_START\_OTA(加密通信)通知人脸识别模块(以下简称模块)进入 OTA 模式;
  - 、模块反馈 OK(不加密通信,后面的都是不加密模式),表示进入了 OTA 模式;
  - 、主控发送 ID\_CONFIG\_BAUDRATE 配置更高波特率,模块反馈 OK 后,主机同步设 置相同波特率,延时 100ms 后才能开始串口数据传输(该配置过程可选,波特率默 认是 115200);
  - 、主控发送 ID\_GET\_OTA\_STATUS;
  - 、模块反馈 OTA 状态和起始包序号;
  - 、主控发送 ID\_OTA\_HEADER,把固件相关信息发送到模块;
  - 、模块反馈 OK;
  - 、主控循环发送升级包 ID\_OTA\_PACKET,收到 OK 后,继续下一包;
  - 、模块收完固件后,开始升级;
  - 、模块升级结束反馈 NID\_OTA\_DONE。

<span id="page-36-1"></span>具体流程参照:"智能人脸模组 OTA 方案软件工作流程.pdf"。

![](_page_37_Picture_1.jpeg)

# <span id="page-37-0"></span>**19** 补充说明

### <span id="page-37-1"></span>**19.1 ID\_REPLY**

主控发送给模块的每条命令,最终都会收到模块的 ID\_REPLY 回复,该消息包含主控发送的 消息 ID(参数 1),命令的执行结果确认码,以及可能返回的消息 data(参数 2)。

```
typedef struct {
   uint8_t mid; // the command(message) id to reply (the request
message ID)
   uint8_t feat_size[4];//command handling result: success or failed
->s_msg_result
   uint8_t data[0]; //参数 2
  } s_msg_reply_data;
 命令的执行结果 result(确认码) 可能是以下几种情况:
  /* message result code */
  typedef enum _s_msg_result
  {
   MR_SUCCESS =0,// success
   MR_REJECTED =1,// module rejected this command
   MR_ABORTED =2,// algo aborted
   MR_FAILED4_CAMERA =4,// camera open failed
   MR_FAILED4_UNKNOWNREASON =5,// unknown_error
   MR_FAILED4_INVALIDPARAM =6,// invalid param
   MR_FAILED4_NOMEMORY =7,// no enough memory
   MR_FAILED4_UNKNOWNUSER =8,// unknown user
   MR_FAILED4_MAXUSER =9,// exceed maximum user number
   MR_FAILED4_FACEENROLLED =10,// this face has been enrolled
   MR_FAILED4_LIVENESSCHECK =12,// liveness check failed
   MR_FAILED4_TIMEOUT =13,// exceed the time limit
   MR_FAILED4_AUTHORIZATION =14,// authorization failed
   MR_FAILED4_CAMERAFOV =15,// camera fov test failed
   MR_FAILED4_CAMERAQUA =16,// camera quality test failed
```

![](_page_38_Picture_1.jpeg)

```
MR_FAILED4_CAMERSTRU =17,// camera structure test
failed
   MR_FAILED4_BOOT_TIMEOUT =18,// boot up timeout
   MR_FAILED4_READ_FILE =19,// read file failed
   MR_FAILED4_WRITE_FILE =20,// write file failed
   MR_FAILED4_NO_ENCRYPT =21,// encrypt must be set
  } s_msg_result_t;
  /* message result code */
```

返回的 data(参数 2)根据 id(参数 1)而有所不同,在头文件 message.h 中,以"s\_msg\_reply\_" 开头的结构体都是各个指令发送 reply 消息时所携带的消息 data,以 verify 命令为例:

```
/* message reply data definitions */
typedef struct {
 uint8_t user_id_heb;
 uint8_t user_id_leb;
 uint8_t user_name[USER_NAME_SIZE];
 uint8_t admin;
} s_user_info_data;
typedef struct {
 s_user_info_data user_info;
 uint8_t unlock_status; /* s_unlock_status */
} s_msg_reply_verify_data;
```

# <span id="page-38-0"></span>**19.2 ID\_NOTE**

MSG::NOTE 消息为模块向主控主动上报的信息,例如当模块上电后会主动向主控发送一条 NOTE,表明自己已经 READY,可以接收主控的命令,主控收到该 NOTE 消息后即可开始发送录 入或者解锁命令。

```
NOTE 消息中所包含的数据为:
typedef struct {
 uint8_t nid; //参数 1
 uint8_t data[0];
} s_msg_note_data;
```

![](_page_39_Picture_1.jpeg)

# <span id="page-39-0"></span>**19.3 ID\_RESET**

主控发送这条命令后,模块将取消之前正在执行的命令(例如录入、解锁等),返回 STANDBY 状态。

### <span id="page-39-1"></span>**19.4 ID\_GETSTATUS**

主控发送该命令后,模块返回自身当前的状态,主要包括:

- MS\_STANDBY(0): 模块处于空闲状态,等待主控命令
- MS\_BUSY(1): 模块处于工作状态
- MS\_ERROR(2): 模块出错,不能正常工作
- <span id="page-39-2"></span>MS\_INVALID(3): 模块未进行初始化

### **19.5 ID\_VERIFY**

```
MSG::VERIFY 为最常用功能,其携带的 data 如下:
// verify
typedef struct {
  uint8_t pd_rightaway; //power down right away after verifying
  uint8_t timeout; //timeout,unit second,default 10s
} s_msg_verify_data;
```

[pd\_rightaway]表示是否在解锁后立刻关机;[timeout]为解锁超时时间(单位 s),默认为 10s, 可以在发送解锁命令时设置,超时时间用户可以任意设定,最大不超过 255s。

解锁过程中,模块可能返回 NOTE 消息,命令执行完会发送 REPLY 消息。NOTE 主要返回 的是当前帧图片中人脸的状态,如人脸位置和姿态。 REPLY 主要返回的是解锁过程执行完毕后的 最终结果,可能返回的确认码包括:MR\_SUCCESS,MR\_FAILED4\_NOSUCHFACE,

MR\_ABORTED 等,详见表 4-7。当返回的确认码是 MR\_SUCCESS 时,表示解锁成功。REPALY 携带的数据表明是什么样的方式解锁,睁眼或者闭眼。数据结构如下:

```
typedef struct {
 s_user_info_data user_info;
 uint8_t unlock_status; /* s_unlock_status */
} s_msg_reply_verify_data;
其中[unlockStatus]代表开锁时的睁闭眼状态,定义如下:
typedef enum {
```

![](_page_40_Picture_1.jpeg)

```
UNLOCK_NORMAL = 200,
 UNLOCK_WITH_EYES_CLOSE = 204,
} s_unlock_status;
```

### <span id="page-40-0"></span>**19.6 ID\_ENROLL**

```
MSG::ENROLL 也是比较常用的功能,其附带的消息 data 如下:
// enroll user
typedef struct {
  uint8_t admin; //the user will be set to admin
  uint8_t user_name[USER_NAME_SIZE];
  s_face_dir face_direction;
  uint8_t timeout; //timeout,unit second default 10s
} s_msg_enroll_data;
```

[admin]指明该录入的人为管理员;[timeout]为录入过程中的超时时间(单位 s),默认为 10s, 可以在发送录入命令时设置,超时时间用户可以随意设置,最大不超过 255s;[face\_direction]表示 用户要录入的人脸方向,有效的人脸方向有 5 种,定义如下:

```
/* msg face direction */
typedef uint8_t s_face_dir;
#define FACE_DIRECTION_UP (1 << 4) // face up
#define FACE_DIRECTION_DOWN (1 << 3) // face down
#define FACE_DIRECTION_LEFT (1 << 2) // face left
#define FACE_DIRECTION_RIGHT (1 << 1) // face right
#define FACE_DIRECTION_MIDDLE (1 << 0) // face middle
#define FACE_DIRECTION_UNDEFINE 0x00 // face undefine
/* msg face direction end */
```

录入过程中可能会返回 NOTE 消息,录入结束会返回 REPLY 消息。

NOTE 主要返回的是当前帧图片中人脸的状态,以及人脸位置和姿态。

REPLY 主要返回录入过程执行完毕后的最终结果,可能返回的确认码详见表 4-7。当返回 MR\_SUCCESSS 时,表示录入成功。REPLY 同时也会携带一些信息返回,如下所示:

```
typedef struct {
 uint8_t user_id_heb;
 uint8_t user_id_leb;
```

![](_page_41_Picture_1.jpeg)

```
uint8_t face_direction;
} s_msg_reply_enroll_data;
```

其中[face\_direction]表示人脸录入状态,数据的低 5 位从高到低分别表示人脸方向的朝上、朝 下、朝左、朝右和正向,如下图 14-1 所示,1 表示该朝向已录入,0 表示该朝向未录入。

图 14-1 人脸录入状态

![](_page_41_Figure_5.jpeg)

## <span id="page-41-0"></span>**19.7ID\_DELUSER**

<span id="page-41-1"></span>MSG::DELUSER 为删除一个已注册的用户,通过 user\_id 指定。

# **19.8 ID\_DELALL**

<span id="page-41-2"></span>MSG::DELALL 为删除所有注册的用户信息。

# **19.9 ID\_GETUSERINFO**

主控通过 user id 指定要返回的注册用户,模块接收到该命令后会返回指定用户的信息,主要 包括以下信息:

```
/* message reply data definitions */
typedef struct {
  uint8_t user_id_heb;
  uint8_t user_id_leb;
  uint8_t user_name[USER_NAME_SIZE];
  uint8_t admin;
} s_user_info_data;
typedef s_user_info_data s_msg_reply_getuserinfo_data;
```

![](_page_42_Picture_1.jpeg)

# <span id="page-42-0"></span>**19.10 ID\_FACERESET**

MSG::FACERESET 消息为重置 SDK 算法状态,如果正在进行交互式录入,发送此消息会重 置录入的状态,已录入的方向全部被清空。

# <span id="page-42-1"></span>**19.11 ID\_POWERDOWN**

主控给模块断电前需先发送 ID\_POWERDOWN 命令,模块收到该命令后进行相应的断电处理 操作,并给主控返回应答消息,主控收到 REPLY 消息后需等待 100ms 再断电,强制断电可能会 对硬件造成损害。在该消息中,系统会将本次开机的操作记录写入文件系统中,为了售后方便获取 问题 log,该消息在断电之前必须调用。

### <span id="page-42-2"></span>**19.12 ID\_DEMOMODE**

主控发送该命令后,模块进入演示模式,这种模式下模块鉴权的流程中将不做特征比对,即所 有人都可以解锁,但是仍然会进行活体检测。

# <span id="page-42-3"></span>**19.13 ID\_SNAPIMAGE**

该命令为图片抓拍,主控下达该指令,并携带需抓拍图片的数量以及抓拍图片的起始编号后, 模块会立刻进行抓拍,将抓拍到的图片按照起始编号依次向后命名并存于本地(jpg 格式)。该功能最 大支持本地存储的图片数量为 20 张,图片编号为 1-20,当主控发送的编号与本地图片编号重复时, 将覆盖原始图片。

```
/* message reply data definitions */
typedef struct {
 uint8_t image_counts; // 需要抓拍的数量
 uint8_t start_number; // 抓拍图片的起始编号
} s_msg_snap_image_data;
```

# <span id="page-42-4"></span>**19.14 ID\_GETSAVDIMAGE & ID\_UPLOADIMAGE**

抓拍的图片将存储在模组本地路径下,主控获取抓拍图片时,首先调用 ID\_GETSAVEDIMAGE 命令获取待上传图片的大小,然后根据需求分多次调用 ID\_UPLOADEIMAGE 来获取图片。 ID\_UPLOADEIMAGE 指令中携带的数据 upload\_image\_offset[4]表示该次上传图片的偏移量(例 如偏移量位 0 时将从图片开头开始传输),upload\_image\_size[4]表示该次上传图片的大小,最大 支持 4000 字节。

![](_page_43_Picture_1.jpeg)

```
typedef struct {
  uint8_t image_number; // picture number to be captured
} s_msg_get_saved_image_data;
```

# <span id="page-43-0"></span>**19.15 ID\_CAPTURE & ID\_UPLOADIMAGE**

```
ID_CAPTURE 获取最近一次注册或者识别的抓拍图片大小(Bytes)
typedef struct {
  uint8_t image_size[4]; // image size, int -> [s1 s2 s3 s4]
} s_msg_reply_capture_data;
```

得到图片大小之后,可以分多次调用 ID\_UPLOADEIMAGE 来获取图片。ID\_UPLOADEIMAGE 指令中携带的数据 upload\_image\_offset[4]表示该次上传图片的偏移量(例如偏移量位 0 时将从图 片开头开始传输),upload\_image\_size[4]表示该次上传图片的大小,最大支持 4000 字节。

ID\_CAPTURE 与 ID\_SNAPIMAGE 的区别在于,ID\_SNAPIMAGE 命令是主动要求摄像头抓拍 一张新图片,而 ID\_CAPTURE 是将最近一次注册或识别的数据读取出来(在注册和识别过程中, 会自动将最后注册或识别成功的图片暂时保存到内存中,直到下一次用户的有效操作才会进行释放)。

# <span id="page-43-1"></span>**19.16 ID\_CAPTURE\_PIC\_TYPE**

该命令主要作用为修改抓拍图片的参数,可修改参数包括分辨率,图片类型(IR 图还是 RGB 图),图片压缩比率,是否裁剪人脸等。命令发送后,下一次模组抓拍的图片会以刚才命令参数中 的新格式保存后传回主控。

```
typedef struct {
    uint8_t pic_width[2]; // capture picture width,int -> [b1, b2]
    uint8_t pic_height[2]; // capture picture height,int -> [b1, b2]
    uint8_t capture_type; // capture type -> IR:0x0 RGB:0x1
    uint8_t compress_ratio; // output picture compress ratio
                      // quality 30%: 0x6; quality 50%: 0x8; quality
80%:0xb
    uint8_t is_cutout_face; // output picture is cutout face partion or not
  } s_msg_get_saved_image_data;
```

# <span id="page-43-2"></span>**19.17 ID\_GET\_ALL\_USERID**

获取所有已注册用户的数量和所有已注册用户的 ID。

![](_page_44_Picture_1.jpeg)

# <span id="page-44-0"></span>**19.18 ID\_GET\_LOGFILE &ID\_UPLOAD\_LOGFILE**

获取日志,通过 ID\_GET\_LOGFILE 指令中携带的参数来选择获取 APP的日志还是 kernel 的 日志,ID\_UPLOAD\_LOGFILE 用于实际将日志上传给主控,这两条指令的使用方式与 ID\_GETSAVDIMAGE & ID\_UPLOADIMAGE 的使用方式完全相同,请参考。

<span id="page-44-1"></span>此处需注意:上传上来的 log 文件是一个 tar 包, 需要先解包再查看里面的内容。

### **19.19 ID\_SET\_RELEASE\_ENC\_KEY**

主控在第一次开机时必须发送该命令,模块会对该指令携带的数据加密并保存,之后模块会用 该数据进行 14.20 中所描述的加密通信。该数据掉电不丢失。

```
typedef struct {
 uint8_t enc_key_number[16];
} s_msg_enc_key_number_data;
```

### <span id="page-44-2"></span>**19.20 ID\_INIT\_ENCRYPTION**

主控下发启动加密命令,模块在该命令后生成密码,本命令的 reply 消息和后续通信均是加密 格式。

启动加密命令数据结构体中除了随机数外, 还包含加密 mode。主控下发的启动加密命令数据 结构体如下:

```
// MID_INIT_ENCRYPTION data
typedef struct {
  uint8_t seed[4]; // random data as a seed
  uint8_t mode; // reserved for selecting encrytion mode
  uint8_t crttime[4];
} s_msg_init_encryption_data;
模块响应的数据结构体如下:
// MID_INIT_ENCRYPTION reply
typedef struct {
  uint8_t device_id[20]; // the unique ID of this device, string type
} s_msg_reply_init_encryption_data;
```

![](_page_45_Picture_1.jpeg)

### <span id="page-45-0"></span>**19.21 ID\_SET\_THRESHOLD\_LEVEL**

该接口用于修改算法安全等, 在不同厂商的与用户的理解中,由于安全要求标准不一致,所以 开放该接口用于设置 liveness 和 verify 的安全阈值,其中 0-4 分别代表:低、较低、正常、较高、 高,默认值为 2 正常。

主控下发结构体如下:

```
typedef struct {
    uint8_t verify_threshold_level;// level 0~4,safety from low to
high,default 2
    uint8_t liveness_threshold_level;// level 0~4,safety from low to
high,default 2
  } s_msg_algo_threshold_data;
```

声明:推荐使用默认设置,安全等级过高易导致通过率降低; 安全等级过低易导致误识问题, 请慎用该设置。

### <span id="page-45-1"></span>**19.22 ID\_ENROLL\_ITG**

```
MSG::ENROLL_ITG 集成支持并扩展所有录入方式,其附带的消息 data 如下:
  // integrated enrollment
  typedef struct {
    uint8_t admin; // the user will be set to admin:1 - admin, 0 - normal
user
    uint8_t user_name[USER_NAME_SIZE];
    uint8_t face_direction;
    /* 0 - interactive, 1 - single */
    uint8_t enroll_type;
    uint8_t enable_duplicate;//0 - disable user duplicate, 1 - enable user
duplicate
    uint8_t timeout; //timeout unit second, default 10s
  } s_msg_enroll_itg;
```

[admin]指明该录入的人为管理员;[timeout]为录入过程中的超时时间(单位 s),默认为 10s, 可以在发送录入命令时设置,超时时间用户可以随意设置,最大不超过 25s;[enroll\_type]选择录入 方式(0 表示交互式录入,1 表示单张录入);[enable\_duplicate]是否允许用户重复录入(0 表示禁

![](_page_46_Picture_1.jpeg)

止用户重复录入,1 表示允许用户重复录入);[resv]目前暂不使用;[face\_direction]表示用户要录 入的人脸方向,有效的人脸方向同 14.6 ID\_ENROLL。

# <span id="page-46-0"></span>**19.23 ID\_GET\_FEATURE\_INFO & ID\_UPLOAD\_FEATURE**

本组命令使用方法与 14.15 中的 ID\_CAPTURE & ID\_UPLOADIMAGE 命令组类似。

ID\_GET\_FEATURE\_INFO 命令可以通过输入已知的注册用户的 ID,获取存在数据库中此 ID 对应的特征信息的大小。

```
typedef struct {
  uint8_t feat_size[4]; // feature size, int -> [s1 s2 s3 s4]
} s_msg_reply_get_face_feature;
```

得到特征信息大小之后,可以分多次调用 ID\_UPLOAD\_FEATURE 来获取特征文件。 ID\_UPLOAD\_FEATURE 指令中携带的数据 upload\_feature\_offset[4]表示该次上传特征信息的的 偏移量(例如偏移量为 0 时将从特征文件开头开始传输),upload\_feature\_size[4]表示该次上传特 征文件的大小,最大支持 4000 字节。

### <span id="page-46-1"></span>**19.24 ID\_TRANS\_FILE\_PACKET & ID\_ENROLL\_WITH\_FEATURE**

在使用特征注册指令前,需要先使用 14.23 所述的组合命令得到特征文件,得到特征文件后, 即可使用此特征文件进行注册。

用特征注册的第一步需要先下发特征文件,接受文件数据的结构体如下:

```
typedef struct {
  uint8_t store_tyep; // must be 0, store in memory
  uint8_t feat_size[4]; // transfer file size, int -> [s1 s2 s3 s4]
  uint8_t offset[4]; // transfer file offset
  uint8_t psize[2]; // packet size
  uint8_t data[0]; // data 0 start
} s_msg_trans_file_data;
```

填写结构体中对应的总文件大小(最大支持 1MB 文件),本包相对于起始文件的偏移量,本包 的大小(所有包大小相加应等于文件大小),数据,然后发送即可。

所有文件数据发送完成后,需特别再发一次偏移量和包大小都为 0 的数据,作为此文件发送结 束的标志。

举例:

```
发送一个 150KB 的文件到模组,单次发送 80KB,发送过程如下:
第一包: file_data(0, 150*1024, 0, 80*1024, data);
```

![](_page_47_Picture_1.jpeg)

第二包: file\_data (0, 150\*1024, 80\*1024, 70\*1024, data);

表明数据传输完成的终止包: file\_data (0, 150\*1024, 0, 0, data)

特征文件传输完成后,使用 ID\_ENROLL\_WITH\_FEATURE 命令进行注册。特征注册时模组固 件会解析特征文件,并以特征文件中包含的信息进行注册。为使各个注册方法的协议保持一致,所 以特征注册协议的参数中也包含了 user\_name, face\_direction 等信息。但因为特征文件中已经包含 了一个用户的所有信息,所以这些参数在模组的固件中没有进行任何处理,其作用仅为填充。

# <span id="page-47-0"></span>**19.25 ID\_TRANS\_FILE\_PACKET & ID\_ENROLL\_FROM\_IMAGE**

用图片注册的第一步需要先下发人脸图片文件,接受文件数据的结构体如下:

```
typedef struct {
  uint8_t store_tyep; // must be 0, store in memory
  uint8_t feat_size[4]; // transfer file size, int -> [s1 s2 s3 s4]
  uint8_t offset[4]; // transfer file offset
  uint8_t psize[2]; // packet size
  uint8_t data[0]; // data 0 start
} s_msg_trans_file_data;
```

填写结构体中对应的总文件大小(最大支持 1MB 文件),本包相对于起始文件的偏移量,本包 的大小(所有包大小相加应等于文件大小),数据,然后发送即可。

所有文件数据发送完成后,需特别再发一次偏移量和包大小都为 0 的数据,作为此文件发送结 束的标志。

举例:

发送一个 150KB 的文件到模组,单次发送 80KB,发送过程如下:

第一包: file\_data(0, 150\*1024, 0, 80\*1024, data);

第二包: file\_data (0, 150\*1024, 80\*1024, 70\*1024, data);

表明数据传输完成的终止包: file\_data (0, 150\*1024, 0, 0, data)

图片文件传输完成后,使用 ID\_ENROLL\_FROM\_IMAGE 命令进行注册。图片注册附带的消息 data 如下:

```
typedef struct {
  uint8_t admin; // the user will be set to admin
  uint8_t user_name[USER_NAME_SIZE];
  uint8_t img_type; // 0 for RGB, 1 for IR, other is invalid
  uint8_t timeout; // timeout, unit second default 10s
} s_msg_enroll_from_img_data;
```

![](_page_48_Picture_1.jpeg)

[admin]指明该录入的人为管理员;[timeout]为录入过程中的超时时间(单位 s),默认为 10s, 可以在发送录入命令时设置,超时时间用户可以随意设置,最大不超过 255s;[img\_type]表示图片 的类型,0 为 RGB 图片,1 为 IR 图片,其他值非法。